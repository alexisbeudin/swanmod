1) an option is available to include turbulence viscosity
2) when coupled with ADCIRC, the default is to use ADCIRC drag formulation
3) change default value of [trfac] for triads
4) changes with respect to netCDF:
    - lower memory usage
    - table output in netCDF format
    - warning non-supported output quantities to prevent crash when outputting
5) variable declaration improved
6) correction computation of output quantity TRANSP
7) small bug fix with vegetation
8) small bug fix with reading input field
9) small bug fix with outputting spectra in case of Doppler shift

--- agioncmd.ftn90	2014-04-18 10:06:53.000000000 +0200
+++ agioncmd.ftn90	2015-02-04 11:52:57.000000000 +0100
@@ -429,8 +429,11 @@
                             'multiply with scale_density') )
                 end if
 
-                if ( spcgrid%relative ) &
-                     call nccheck ( nf90_put_att( ncid, evarid, 'relative_to_current', 'true') )
+                if ( spcgrid%relative ) then
+                    call nccheck ( nf90_put_att( ncid, evarid, 'relative_to_current', 'true') )
+                else
+                    call nccheck ( nf90_put_att( ncid, evarid, 'relative_to_current', 'false') )
+                end if
 
                 !
                 ! scale_density
@@ -464,8 +467,11 @@
                 call nccheck ( nf90_put_att( ncid, evarid, 'units', 'm2 s') )
                 call nccheck ( nf90_put_att( ncid, evarid, 'standard_name', 'sea_surface_wave_variance_spectral_density') )
 
-                if ( spcgrid%relative ) &
-                     call nccheck ( nf90_put_att( ncid, evarid, 'relative_to_current', 'true') )
+                if ( spcgrid%relative ) then
+                    call nccheck ( nf90_put_att( ncid, evarid, 'relative_to_current', 'true') )
+                else
+                    call nccheck ( nf90_put_att( ncid, evarid, 'relative_to_current', 'false') )
+                end if
                 call agnc_add_coordinates_attribute(ncid, evarid)
 
                 !
@@ -1296,9 +1302,11 @@
             type(recordaxe_type)                            :: recordaxe
             logical                                         :: do_scale
             chunksize = 64
+            do_scale = .false.
 
             call agnc_get_griddef(ncid, spcgrid)
             call agnc_get_recordaxe(ncid, recordaxe)
+            call agnc_collect_spcmeta_2d(ncid, varid_density, varid_scale_density, fv_density)
 
             if ( spc_as_map ) then
                 call agnc_get_griddef(ncid, mapgrid)
@@ -1308,36 +1316,60 @@
                 msc = pntgrid%npoints
             end if
 
-            call agnc_collect_spcmeta_2d(ncid, varid_density, varid_scale_density, fv_density)
-
-            do_scale = .false.
-            if ( varid_scale_density > 0 ) do_scale = .true.
-
+            ! should I scale and write in a big chuncked loop over msc?
+            ! Allocating the density array creates a new copy for all 2D spectral points in the heap.
             allocate(density(spcgrid%ndir, spcgrid%nfreq, msc))
 
-            ! Note the assumption that AGNC_FILL_SHORT is negative
-            if ( do_scale ) then
-                where ( abs(e2d - AGNC_DUMMY) < epsilon(1.) ) e2d = AGNC_FILL_SHORT
+            !
+            ! - scale and/or replace energy dummies with _FillValue
+            ! - if scaling requested, write scale factors to netcdf
+            !
+            if ( varid_scale_density > 0 ) then
+                do_scale = .true.
                 allocate(scale_density(msc))
+
+                ! Note the assumption that AGNC_FILL_SHORT is negative
                 scale_density = maxval(e2d, 1) / (2**15-1)
-                where (scale_density < epsilon(1.) ) scale_density=epsilon(1.)
-            else
-                where ( abs(e2d - AGNC_DUMMY) < epsilon(1.) ) e2d = NF90_FILL_FLOAT
-            end if
 
-            do ip=1, msc
-                do ith=1, spcgrid%ndir
+                do ip=1, msc
+                    if (scale_density(ip) < epsilon(1.) ) scale_density(ip) = epsilon(1.)
                     do ik=1, spcgrid%nfreq
-                        isp = ith + (ik - 1) * spcgrid%ndir
-                        if ( do_scale .and. abs(e2d(isp,ip) - AGNC_FILL_SHORT) > epsilon(1.) ) then
-                            density(ith,ik,ip) = nint(e2d(isp,ip) / scale_density(ip))
-                        else
-                            density(ith,ik,ip) = e2d(isp,ip)
-                        end if
+                        do ith=1, spcgrid%ndir
+                            isp = ith + (ik - 1) * spcgrid%ndir
+                            if ( abs(e2d(isp,ip) - AGNC_DUMMY) > epsilon(1.) ) then
+                                density(ith,ik,ip) = nint(e2d(isp,ip) / scale_density(ip))
+                            else
+                                density(ith,ik,ip) = AGNC_FILL_SHORT
+                            end if
+                        end do
                     end do
                 end do
-            end do
 
+                if ( spc_as_map ) then
+                    call nccheck ( nf90_put_var(ncid, varid_scale_density, &
+                                    reshape(scale_density, (/mapgrid%nx, mapgrid%ny, 1/)), (/1, 1, ti/)) )
+                else
+                    call nccheck ( nf90_put_var(ncid, varid_scale_density, scale_density, (/1, ti/)) )
+                end if
+            else
+                ! replace unscaled energy dummies with _FillValue
+                do ip=1, msc
+                    do ik=1, spcgrid%nfreq
+                        do ith=1, spcgrid%ndir
+                            isp = ith + (ik - 1) * spcgrid%ndir
+                            if ( abs(e2d(isp,ip) - AGNC_DUMMY) > epsilon(1.) ) then
+                                density(ith,ik,ip) = e2d(isp,ip)
+                            else
+                                density(ith,ik,ip) = NF90_FILL_FLOAT
+                            end if
+                        end do
+                    end do
+                end do
+            end if
+
+            !
+            ! chunked write to netcdf
+            !
             if ( spc_as_map ) then
                 allocate(edloc(spcgrid%ndir, spcgrid%nfreq, chunksize, chunksize))
 
@@ -1359,20 +1391,20 @@
                 end do
                 deallocate(edloc)
             else
-                call nccheck ( nf90_put_var(ncid, varid_density, density, (/1,1,1,ti/)) )
+                do ip=1,msc, chunksize**2
+                    ! abuse sx and cx for size and end index in pointlist
+                    sx = minval( (/chunksize**2, msc-ip+1/) )
+                    cx = ip + sx - 1
+
+                    call nccheck ( nf90_put_var(ncid, varid_density, density(:,:,ip:cx), &
+                                                                      (/1,1,ip,ti/),      &
+                                                                      (/spcgrid%ndir, spcgrid%nfreq, sx, 1/) ) )
+                end do
             end if
 
             deallocate(density)
 
-            if (do_scale) then
-                if ( spc_as_map ) then
-                    call nccheck ( nf90_put_var(ncid, varid_scale_density, &
-                                    reshape(scale_density, (/mapgrid%nx, mapgrid%ny, 1/)), (/1, 1, ti/)) )
-                else
-                    call nccheck ( nf90_put_var(ncid, varid_scale_density, scale_density, (/1, ti/)) )
-                end if
-                deallocate(scale_density)
-            end if
+            if (do_scale) deallocate(scale_density)
 
         end subroutine agnc_add_spcdata_density
 
@@ -1416,6 +1448,7 @@
             type(recordaxe_type)                                :: recordaxe
             logical                                             :: do_scale
             chunksize = 64
+            do_scale = .false.
 
             call agnc_get_griddef(ncid, spcgrid)
             call agnc_get_recordaxe(ncid, recordaxe)
@@ -1432,25 +1465,27 @@
                 msc = pntgrid%npoints
             end if
             if ( msc /= size(energy,2) ) then
-                write(6,*) '#points of this run and the netcdf file is different: ', msc, size(energy,2)
+                write(6,*) '#points of this run and the netcdf file is different'
                 STOP 2
             end if
 
-            do_scale = .false.
             if ( varid_scale_energy > 0 ) then
                 do_scale = .true.
 
                 allocate(scale_energy(msc))
 
-                where ( abs(energy - AGNC_DUMMY) <= epsilon(1.) ) energy = AGNC_FILL_SHORT
-
-                ! Note the assumption that AGNC_FILL_SHORT is negative
+                ! Note the assumption that AGNC_DUMMY is negative (or zero)
                 scale_energy = maxval(energy, 1) / (2**15-1)
-                where (scale_energy < epsilon(1.) ) scale_energy=epsilon(1.)
+
                 do ip=1, msc
+                    ! scale or replace energy dummies with _FillValue
+                    if (scale_energy(ip) < epsilon(1.) ) scale_energy(ip) = epsilon(1.)
                     do ik=1, spcgrid%nfreq
-                        if ( abs(energy(ik,ip) - AGNC_FILL_SHORT) > epsilon(1.)) &
-                        energy(ik,ip) = nint(energy(ik,ip) / scale_energy(ip))
+                        if ( abs(energy(ik,ip) - AGNC_DUMMY) > epsilon(1.)) then
+                            energy(ik,ip) = nint(energy(ik,ip) / scale_energy(ip))
+                        else
+                            energy(ik,ip) = AGNC_FILL_SHORT
+                        end if
                     end do
                 end do
 
@@ -1462,21 +1497,34 @@
                     call nccheck ( nf90_put_var(ncid, varid_scale_energy, scale_energy, (/1, ti/)) )
                 end if
             else
-                where ( abs(energy - AGNC_DUMMY) < epsilon(1.) ) energy = NF90_FILL_FLOAT
+                ! replace unscaled energy dummies with _FillValue
+                do ip=1, msc
+                    do ik=1, spcgrid%nfreq
+                        if ( abs(energy(ik,ip) - AGNC_DUMMY) < 2*epsilon(1.)) &
+                          energy(ik,ip) = NF90_FILL_FLOAT
+                    end do
+                end do
             end if
 
-            where ( abs(theta - AGNC_DUMMY) > epsilon(1.) )
-                theta = nint((theta - ao_theta) / sf_theta)
-            elsewhere
-                theta = AGNC_FILL_BYTE
-            end where
-
-            where ( abs(spr - AGNC_DUMMY) > epsilon(1.) )
-                spr = nint((spr - ao_spr) / sf_spr)
-            elsewhere
-                spr = AGNC_FILL_BYTE
-            end where
+            ! replace direction and spread dummies with _FillValue
+            do ip=1, msc
+                do ik=1, spcgrid%nfreq
+                    if ( abs(theta(ik,ip) - AGNC_DUMMY) > epsilon(1.) ) then
+                        theta(ik,ip) = nint((theta(ik,ip) - ao_theta) / sf_theta)
+                    else
+                        theta(ik,ip) = AGNC_FILL_BYTE
+                    end if
+                    if ( abs(spr(ik,ip) - AGNC_DUMMY) > epsilon(1.) ) then
+                        spr(ik,ip) = nint((spr(ik,ip) - ao_spr) / sf_spr)
+                    else
+                        spr(ik,ip) = AGNC_FILL_BYTE
+                    end if
+                end do
+            end do
 
+            !
+            ! chunked write to netcdf
+            !
             if ( spc_as_map ) then
                 allocate(eloc(spcgrid%nfreq, chunksize, chunksize))
                 allocate(tloc(spcgrid%nfreq, chunksize, chunksize))
@@ -1512,12 +1560,23 @@
                 deallocate(tloc)
                 deallocate(sloc)
             else
-                call nccheck ( nf90_put_var(ncid, varid_energy, energy, (/1,1,ti/)) )
-                call nccheck ( nf90_put_var(ncid, varid_theta, theta, (/1,1,ti/)) )
-                call nccheck ( nf90_put_var(ncid, varid_spr, spr, (/1,1,ti/)) )
+                do ip=1,msc, chunksize**2
+                    ! abuse sx and cx for size and end index in pointlist
+                    sx = minval( (/chunksize**2, msc-ip+1/) )
+                    cx = ip + sx - 1
+
+                    call nccheck ( nf90_put_var(ncid, varid_energy, energy(:,ip:cx), &
+                                                                     (/1,ip,ti/),    &
+                                                                     (/spcgrid%nfreq, sx,  1/) ))
+                    call nccheck ( nf90_put_var(ncid, varid_theta,  theta(:,ip:cx),  &
+                                                                     (/1,ip,ti/),    &
+                                                                     (/spcgrid%nfreq, sx,  1/) ))
+                    call nccheck ( nf90_put_var(ncid, varid_spr,    spr(:,ip:cx),    &
+                                                                     (/1,ip,ti/),    &
+                                                                     (/spcgrid%nfreq, sx,  1/) ))
+                end do
             end if
             if ( do_scale ) deallocate(scale_energy)
-
         end subroutine agnc_add_spcdata_2d
 
         subroutine agnc_add_pntdata1d_float(ncid, varname, ti, values, dummyvalue, skip_range_error)
--- HottifySWAN.ftn90	2014-04-18 10:06:54.000000000 +0200
+++ HottifySWAN.ftn90	2015-02-04 11:52:58.000000000 +0100
@@ -7,7 +7,7 @@
 !     This program is specifically meant for unstructured SWAN grids.
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- Makefile	2014-04-18 10:06:53.000000000 +0200
+++ Makefile	2015-02-04 11:52:57.000000000 +0100
@@ -34,6 +34,7 @@
 SwanGriddata.$(EXTO) \
 SwanGridobjects.$(EXTO) \
 SwanCompdata.$(EXTO) \
+SdsBabanin.$(EXTO) \
 $(NCF_OBJS) \
 swanmain.$(EXTO) \
 swanpre1.$(EXTO) \
--- m_fileio.ftn90	2014-04-18 10:06:55.000000000 +0200
+++ m_fileio.ftn90	2015-02-04 11:52:58.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -83,7 +83,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -371,7 +371,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -427,7 +427,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- mod_xnl4v5.ftn90	2014-04-18 10:06:55.000000000 +0200
+++ mod_xnl4v5.ftn90	2015-02-04 11:52:58.000000000 +0100
@@ -469,7 +469,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -853,7 +853,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1075,7 +1075,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1204,7 +1204,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1461,7 +1461,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1676,7 +1676,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1804,7 +1804,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1911,7 +1911,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2219,7 +2219,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2705,7 +2705,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2858,7 +2858,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3059,7 +3059,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3542,7 +3542,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3855,7 +3855,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4254,7 +4254,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4675,7 +4675,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5145,7 +5145,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5302,7 +5302,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5579,7 +5579,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5882,7 +5882,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -6158,7 +6158,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -6289,7 +6289,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -6526,7 +6526,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -6627,7 +6627,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -6992,7 +6992,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -7219,7 +7219,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -7369,7 +7369,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -7806,7 +7806,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -7908,7 +7908,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -8025,7 +8025,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -8137,7 +8137,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -8267,7 +8267,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -8371,7 +8371,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -8476,7 +8476,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -8915,7 +8915,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- ocpcre.ftn	2014-04-18 10:07:14.000000000 +0200
+++ ocpcre.ftn	2015-02-04 11:53:04.000000000 +0100
@@ -44,7 +44,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -132,7 +132,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -242,7 +242,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -391,7 +391,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -516,7 +516,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -712,7 +712,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -874,7 +874,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1070,7 +1070,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1264,7 +1264,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1409,7 +1409,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1792,7 +1792,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1901,7 +1901,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2002,7 +2002,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2110,7 +2110,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2222,7 +2222,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2336,7 +2336,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2425,7 +2425,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- ocpids.ftn	2014-04-18 10:07:14.000000000 +0200
+++ ocpids.ftn	2015-02-04 11:53:04.000000000 +0100
@@ -28,7 +28,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -356,7 +356,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -455,7 +455,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -580,7 +580,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- ocpmix.ftn	2014-04-18 10:07:14.000000000 +0200
+++ ocpmix.ftn	2015-02-04 11:53:04.000000000 +0100
@@ -41,7 +41,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -181,7 +181,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -380,7 +380,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -471,7 +471,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -569,7 +569,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -802,7 +802,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1172,7 +1172,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1285,7 +1285,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1433,7 +1433,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1534,7 +1534,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1633,7 +1633,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1983,7 +1983,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2110,7 +2110,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2304,7 +2304,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2400,7 +2400,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SdsBabanin.ftn90	1970-01-01 01:00:00.000000000 +0100
+++ SdsBabanin.ftn90	2015-02-04 11:52:58.000000000 +0100
@@ -0,0 +1,2 @@
+!   This file contains subroutines for the Babanin physics according to Rogers et al (JTECH 2012)
+!   based on work of Babanin, Young, Tsagareli, Ardhuin and others
--- serv_xnl4v5.ftn90	2014-04-18 10:06:57.000000000 +0200
+++ serv_xnl4v5.ftn90	2015-02-04 11:52:58.000000000 +0100
@@ -54,7 +54,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -130,7 +130,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -341,7 +341,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -451,7 +451,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -520,7 +520,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -738,7 +738,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -808,7 +808,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanBndStruc.ftn90	2014-04-18 10:06:57.000000000 +0200
+++ SwanBndStruc.ftn90	2015-02-04 11:52:59.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanBpntlist.ftn90	2014-04-18 10:07:14.000000000 +0200
+++ SwanBpntlist.ftn90	2015-02-04 11:53:04.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanCheckGrid.ftn90	2014-04-18 10:06:57.000000000 +0200
+++ SwanCheckGrid.ftn90	2015-02-04 11:52:59.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- swancom1.ftn	2014-04-18 10:07:14.000000000 +0200
+++ swancom1.ftn	2015-02-04 11:53:04.000000000 +0100
@@ -64,6 +64,8 @@
       USE m_xnldata                                                       40.41
       USE m_fileio                                                        40.41
 !
+      IMPLICIT NONE
+!
 !
 !   --|-----------------------------------------------------------|--
 !     | Delft University of Technology                            |
@@ -76,7 +78,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -550,8 +552,10 @@
 !     MSGERR : Handles error messages according to severity               40.41
 !     NUMSTR : Converts integer/real to string                            40.41
 !     TXPBLA : Removes leading and trailing blanks in string              40.41
+!MPI!     STPNOW : Logical indicating whether program must
+!MPI!              terminated or not
 !
-      LOGICAL STPNOW                                                      34.01
+!MPI      LOGICAL STPNOW                                                      34.01
 !
 !  9. Subroutines calling
 !
@@ -856,6 +860,9 @@
 !$    INTEGER, EXTERNAL :: OMP_GET_NUM_THREADS, OMP_GET_THREAD_NUM        40.31
       INTEGER I1GRD,I2GRD,I1MYC,I2MYC                                     40.31
 !
+      INTEGER IENT, MSTPDA, KWIND, KWCAP, KQUAD, IYSTEP, J, IJ, IK, ID
+      REAL ALFAT, GRWOLD
+!
 !-----------------------------------------------------------------------
 !                      End of variable definition
 !-----------------------------------------------------------------------
@@ -2084,6 +2091,8 @@
       USE SWCOMM4                                                         40.41
       USE M_PARALL                                                        40.31
 !
+      IMPLICIT NONE
+!
 !
 !   --|-----------------------------------------------------------|--
 !     | Delft University of Technology                            |
@@ -2096,7 +2105,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2291,8 +2300,6 @@
 !     SPROSD
 !     SWPSEL
 !
-      LOGICAL STPNOW                                                      34.01
-!
 !  9. Subroutines calling
 !
 !     SWCOMP
@@ -2480,12 +2487,12 @@
      &         DA2M(MSC4MI:MSC4MA , MDC4MI:MDC4MA )  ,
      &         SFNL(MSC4MI:MSC4MA , MDC4MI:MDC4MA )  ,
      &         DSNL(MSC4MI:MSC4MA , MDC4MI:MDC4MA )  ,
-     &         MEMNL4(MDC,MSC,MCGRD)               ,                      30.21
+     &         MEMNL4(MDC,MSC,MCGRD)                 ,                    30.21
      &         SWTSDA(MDC,MSC,NPTSTA,MTSVAR)         ,                    40.00
      &         WWAWG(*)                              ,
      &         WWSWG(*)                              ,
-     &         RDX(10)       ,RDY(10)               ,                     15/MAY 40.08
-     &         OBREDF(MDC,MSC,2)                    ,                     040697
+     &         RDX(MICMAX)   ,RDY(MICMAX)            ,                    15/MAY 40.08
+     &         OBREDF(MDC,MSC,2)                     ,                    040697
      &         REFLSO(MDC,MSC)                                            40.41
 !
       LOGICAL  GROWW(MDC,MSC)    ,
@@ -2493,6 +2500,9 @@
 !
       INTEGER :: ISLMIN(MCGRD), NFLIM(MCGRD), NRSCAL(MCGRD)               40.23
 !
+      INTEGER IENT, NLINK, ILINK, II, INDEX, ID, IDC, ISC,
+     &        ID_MIN, ID_MAX, IDDUM
+!
       SAVE IENT
       DATA IENT/0/
       IF (LTRACE) CALL STRACE (IENT,'SWOMPU')
@@ -2906,6 +2916,7 @@
           CALL SPREDT (SWPDIR           ,AC2               ,CAX       ,
      &                 CAY              ,IDCMIN            ,IDCMAX    ,
      &                 ISSTOP           ,LSWMAT(1,1,JABIN) ,              40.02
+     &                 XCGRID           ,YCGRID            ,              41.53
      &                 RDX              ,RDY               ,OBREDF    )   40.00
            LPREDT=.FALSE.
         END IF
@@ -3242,7 +3253,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3475,11 +3486,16 @@
       ENDIF                                                               40.59
 !
       IF (IWCAP.EQ.1) THEN
-         WRITE(PRINTF,6005) PWCAP(1),PWCAP(2)
-         WRITE(PRINTF,6006) PWCAP(10)
- 6005    FORMAT(' W-cap Komen (`84)    : EMPCOF ',E12.4,
-     &          ' APM   ',E12.4)
- 6006    FORMAT('                      : DELTA  ',E12.4)                  41.41
+         WRITE(PRINTF,'(2A,E12.4)')' W-cap Komen (`84)    : ',
+     &                             'EMPCOF (CDS2): ',PWCAP(1)
+         WRITE(PRINTF,'(2A,E12.4)')' W-cap Komen (`84)    : ',
+     &                             'APM (STPM)   : ',PWCAP(2)
+         WRITE(PRINTF,'(2A,E12.4)')' W-cap Komen (`84)    : ',
+     &                             'POWST        : ',PWCAP(9)
+         WRITE(PRINTF,'(2A,E12.4)')' W-cap Komen (`84)    : ',
+     &                             'DELTA        : ',PWCAP(10)
+         WRITE(PRINTF,'(2A,E12.4)')' W-cap Komen (`84)    : ',
+     &                             'POWK         : ',PWCAP(11)
       ELSEIF (IWCAP.EQ.2) THEN
          WRITE(PRINTF,6335) PWCAP(3),PWCAP(4)
  6335    FORMAT(' W-cap Janssen (`90)  : CFJANS ',E12.4,
@@ -3506,6 +3522,10 @@
          WRITE (PRINTF, *) 'Whitecapping is off'
       ENDIF
 !
+      IF (IWIND.EQ.3) THEN                                                40.88
+         WRITE (PRINTF, *) 'Snyder/Komen wind input'                      40.88
+      ENDIF                                                               40.88
+!
       IF (ISURF.EQ.1) THEN
          WRITE(PRINTF,7012) PSURF(1),PSURF(2)
  7012    FORMAT(' Battjes&Janssen (`78): ALPHA  ',E12.4,
@@ -3615,6 +3635,8 @@
       USE SWCOMM4                                                         40.41
       USE M_PARALL                                                        40.31
 !
+      IMPLICIT NONE
+!
 !   --|-----------------------------------------------------------|--
 !     | Delft University of Technology                            |
 !     | Faculty of Civil Engineering                              |
@@ -3627,7 +3649,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3741,8 +3763,10 @@
 !
       LOGICAL LHEAD, TSTFL                                                40.41
 !
-!  7. Common blocks used
+      INTEGER IENT, II
+      REAL  ACS2, ACS3
 !
+!  7. Common blocks used
 !
 !     Place local summed variables in common block so they will           40.31
 !     be scoped as shared                                                 40.31
@@ -3756,7 +3780,8 @@
 !                      terminated or not
 !     SWREDUCE         Performs a global reduction
 !
-      LOGICAL EQREAL, STPNOW
+      LOGICAL EQREAL
+!MPI      LOGICAL STPNOW
 !
 !  9. Subroutines calling
 !
@@ -4091,7 +4116,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4204,6 +4229,8 @@
      &         HSACC2(MCGRD)        ,                                     30.21
      &         SACC2(MCGRD)                                               30.21
 !
+      INTEGER IENT
+!
       SAVE IENT
       DATA IENT/0/
       IF (LTRACE) CALL STRACE (IENT,'INSAC')
@@ -4311,7 +4338,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4512,7 +4539,7 @@
      &         IMATUA(MDC,MSC)     ,IMATRA(MDC,MSC)     ,
      &         IMAT5L(MDC,MSC)     ,IMAT6U(MDC,MSC)     ,
      &         LEAKC1(MDC,MSC)
-      REAL  :: RDX(10)             ,RDY(10)             ,                 33.09 40.08
+      REAL  :: RDX(MICMAX)         ,RDY(MICMAX)         ,                 33.09 40.08
      &         OBREDF(MDC,MSC,2)   ,
      &         SPCDIR(MDC,6)                                              33.08
       REAL  :: TRAC0 (1:MDC,1:MSC,1:MTRNP)                                40.85
@@ -4520,6 +4547,8 @@
 !
       LOGICAL  ANYBLK(MDC,MSC)     ,ANYBIN(MDC,MSC)
 !
+      INTEGER IENT
+!
       SAVE IENT
       DATA IENT/0/
       IF (LTRACE) CALL STRACE (IENT,'ACTION')
@@ -4681,7 +4710,8 @@
      &                   ABRBOT  ,UBOT    ,HS      ,QB      ,             40.02
      &                   HM      ,KMESPC  ,SMEBRK  ,KTETA   ,             41.47 40.02
      &                   TMBOT   ,BOTLV   ,GAMBR   ,RESPL   ,             41.38 40.51 40.16
-     &                   SWPDIR  ,IDDLOW  ,IDDTOP  )                      41.38
+     &                   SWPDIR  ,                                        41.38
+     &                   IDDLOW  ,IDDTOP  )                               41.38
 !
 !****************************************************************
 !
@@ -4706,7 +4736,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4844,7 +4874,7 @@
       REAL, INTENT(INOUT)  :: GAMBR(MCGRD), RESPL(MCGRD)                  41.38
 !     Changed ICMAX to MICMAX, since MICMAX doesn't vary over gridpoint   40.22
       REAL, INTENT(IN)     :: KWAVE(MSC,MICMAX)                           40.22
-      REAL, INTENT(IN)     :: RDX(10), RDY(10)                            40.08
+      REAL, INTENT(IN)     :: RDX(MICMAX), RDY(MICMAX)                    40.08
       REAL, INTENT(IN)     :: SPCDIR(MDC,6)
 !
       REAL, INTENT(IN OUT) :: AC2(MDC,MSC,MCGRD)
@@ -5033,7 +5063,7 @@
 !
         IF ( UB2 .GT. 0.) UBOT(KCGRD(1)) = SQRT ( UB2 )
         IF ( AB2 .GT. 0.) ABRBOT = SQRT (2. *  AB2)
-        IF ( UB2.GT.0. .AND. AB2.GT.0. )                                  40.51
+        IF ( UB2 .GT. 0. .AND. AB2 .GT. 0. )                              40.51
      &                               TMBOT(KCGRD(1)) = PI2*SQRT(AB2/UB2)  40.51
 !
       ENDIF
@@ -5142,7 +5172,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5362,7 +5392,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5608,7 +5638,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5967,7 +5997,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -6261,7 +6291,6 @@
      &         SNLC1   ,FACHFR  ,DAL1    ,DAL2    ,DAL3    ,
      &         UFRIC   ,SMEBRK  ,HS      ,XIS     ,KTETA
 !
-!
       REAL  :: AC2(MDC,MSC,MCGRD)                                         30.21
       REAL  :: DEP2(MCGRD)
       REAL  :: ALIMW(MDC,MSC)
@@ -6420,11 +6449,12 @@
 !       *** linear wind input according to Cavaleri and Malanotte ***
 !       *** Rizolli (1981) for a third generation mode of SWAN    ***
 !
-        IF (PWIND(31) .GT. 1.E-20)                                        7/MAR
-     &  CALL SWIND0 (IDCMIN  ,IDCMAX  ,ISSTOP  ,
-     &               SPCSIG  ,THETAW  ,ANYWND  ,
-     &               UFRIC   ,FPM     ,PLWNDA  ,
-     &               IMATRA  ,SPCDIR  ,GENC0   )
+        IF (PWIND(31) .GT. 1.E-20) THEN
+           CALL SWIND0 (IDCMIN  ,IDCMAX  ,ISSTOP  ,
+     &                  SPCSIG  ,THETAW  ,ANYWND  ,
+     &                  UFRIC   ,FPM     ,PLWNDA  ,
+     &                  IMATRA  ,SPCDIR  ,GENC0   )
+        ENDIF
       ENDIF
 !
       IF ( IWIND .EQ. 1 .OR. IWIND .EQ. 2 ) THEN                          970220
@@ -6468,14 +6498,16 @@
       END IF
 !TIMG      CALL SWTSTO(132)                                                    40.23
 !
-!     Calculate whitecapping source term (six formulations)               40.31 40.02
+!     Calculate whitecapping source term (multiple formulations)          40.31 40.02
 !
 !TIMG      CALL SWTSTA(133)                                                    40.23
-      IF (IWCAP.GE.1) CALL SWCAP (SPCDIR  ,SPCSIG  ,KWAVE   ,AC2     ,    40.02
+      IF (IWCAP.GE.1) THEN
+      IF (IWCAP.LE.7) CALL SWCAP (SPCDIR  ,SPCSIG  ,KWAVE   ,AC2     ,    40.02
      &                            IDCMIN  ,IDCMAX  ,ISSTOP  ,             40.02
      &                            ETOT    ,IMATDA  ,IMATRA  ,PLWCAP  ,    40.02
      &                            CGO     ,UFRIC   ,                      40.53
      &                            DEP2    ,DISSC1  ,DISSC0  )             40.67 40.61 40.12
+      END IF
 !TIMG      CALL SWTSTO(133)                                                    40.23
 !
 !     compute nonlinear interactions, starting with triads                 NB!
@@ -6489,7 +6521,7 @@
 !
         IF ( ICUR .EQ. 0 .OR. ITER .GT. 1 ) THEN
 !
-           IF (ITRIAD.EQ.1) THEN
+           IF (ITRIAD.EQ.1.OR.ITRIAD.EQ.11) THEN
 !             LTA
               CALL SWLTA ( AC2   , DEP2  , CGO   , SPCSIG,                40.56
      &                     KWAVE , IMATRA, IMATDA, REDC0 , REDC1 ,        40.85
@@ -6734,7 +6766,6 @@
       IMPLICIT NONE
 !
 !
-!
 !   --|-----------------------------------------------------------|--
 !     | Delft University of Technology                            |
 !     | Faculty of Civil Engineering                              |
@@ -6746,7 +6777,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -6897,7 +6928,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -7041,7 +7072,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -7230,7 +7261,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -7841,7 +7872,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -8350,7 +8381,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -8468,7 +8499,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -8590,7 +8621,8 @@
 !                      terminated or not
 !     SWREDUCE         Performs a global reduction
 !
-      LOGICAL EQREAL, STPNOW
+      LOGICAL EQREAL
+!MPI      LOGICAL STPNOW
 !
 !  9. Subroutines calling
 !
@@ -8786,7 +8818,7 @@
 !MPI      IF (STPNOW()) RETURN
       IACCUR = IARR(1)
       WETGRD = IARR(2)
-      ACCUR  = REAL(IACCUR) * 100. / REAL(WETGRD)
+      ACCUR  = CEILING(REAL(IACCUR) * 10000. / REAL(WETGRD))/100.
 !$OMP END MASTER
 !$OMP BARRIER
 !
@@ -8828,7 +8860,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -9383,7 +9415,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- swancom2.ftn	2014-04-18 10:07:14.000000000 +0200
+++ swancom2.ftn	2015-02-04 11:53:04.000000000 +0100
@@ -48,7 +48,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -552,6 +552,7 @@
 !
 !****************************************************************
 !
+      USE SWCOMM2
       USE SWCOMM3
       USE SWCOMM4
       USE OCPCOMM4
@@ -571,7 +572,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -753,8 +754,8 @@
       KD    = KMESPC * DEP2(KCGRD(1))
       IF ( KD.GT.10. ) RETURN
       C     = 3.*KMESPC*(COSH(KD))**3
-      SVEG1 = SQRT(2./PI) * GRAV**2 * (KMESPC/SMEBRK)**3 * SQRT(ETOT)
-     &                    * NPLA2(KCGRD(1)) / C
+      SVEG1 = SQRT(2./PI) * GRAV**2 * (KMESPC/SMEBRK)**3 * SQRT(ETOT)/ C
+      IF ( VARNPL ) SVEG1 = SVEG1 * NPLA2(KCGRD(1))
 
 !     --- compute dissipation factor for each layer and summed up
 
@@ -882,7 +883,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1029,7 +1030,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1162,7 +1163,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1362,7 +1363,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1783,7 +1784,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2227,7 +2228,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2325,7 +2326,7 @@
       REAL, INTENT(INOUT)  :: RESPL(MCGRD)      ! response length         41.38
 !
 !     RDX, RDY:  coefficients to obtain spatial derivatives               40.22
-      REAL, INTENT(IN)  :: RDX(10), RDY(10)                               40.08
+      REAL, INTENT(IN)  :: RDX(MICMAX), RDY(MICMAX)                       40.08
       REAL, INTENT(IN)  :: KWAVE(MSC,MICMAX)                              41.03
       REAL, INTENT(IN)  :: FDIR ! represents first spectral direction     41.38
       INTEGER, INTENT(IN) :: IDDLOW, IDDTOP                               41.38
@@ -2616,7 +2617,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- swancom3.ftn	2014-04-18 10:07:14.000000000 +0200
+++ swancom3.ftn	2015-02-04 11:53:04.000000000 +0100
@@ -53,7 +53,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -568,7 +568,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -901,6 +901,14 @@
 !       *** determine U friction in case predictor is obtained ***
 !       *** with second genaration wave model                  ***
 !
+!       added the default option to use the ADCIRC drag formulation
+!ADC        IF ( IDRAG.EQ.0 ) THEN
+!ADC           IF ( WIND10 .GT. 7.5 ) THEN
+!ADC              CDRAG = WindDrag(DBLE(WIND10),NodeNumber)
+!ADC           ELSE
+!ADC              CDRAG = 0.0012873
+!ADC           ENDIF
+!ADC        ENDIF
         IF ( IDRAG.EQ.1 ) THEN
            IF ( WIND10 .GT. 7.5 ) THEN
              CDRAG = ( 0.8 + 0.065 * WIND10 ) * 0.001
@@ -957,7 +965,7 @@
            CDRAG = MAX ( 0.7  , CDRAG )
            CDRAG = CDRAG * 0.001
            CDRAG = MIN ( CDCAP, CDRAG )
-        END IF
+        ENDIF
 !
         UFRIC = SQRT ( CDRAG ) * WIND10
 !
@@ -974,11 +982,20 @@
 !       *** according to Wu (1982)                ***
 !       *** apply cd-cap if appropriate           ***
 !
+!       added the default option to use the ADCIRC drag formulation
+!ADC        IF ( IDRAG.EQ.0 ) THEN
+!ADC           IF ( WIND10 .GT. 7.5 ) THEN
+!ADC              CDRAG = WindDrag(DBLE(WIND10),NodeNumber)
+!ADC           ELSE
+!ADC              CDRAG = 0.0012873
+!ADC           ENDIF
+!ADC        ENDIF
         IF ( IDRAG.EQ.1 ) THEN
            IF ( WIND10 .GT. 7.5 ) THEN
              CDRAG = ( 0.8 + 0.065 * WIND10 ) * 0.001
              CDRAG = MIN ( CDCAP, CDRAG )
-!ADC             CDRAG = WindDrag(DBLE(WIND10),NodeNumber)
+!            this call is deprecated
+!ADC!             CDRAG = WindDrag(DBLE(WIND10),NodeNumber)
            ELSE
              CDRAG = 0.0012873
            ENDIF
@@ -1090,7 +1107,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1323,7 +1340,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1488,6 +1505,8 @@
       USE SWCOMM4                                                         40.41
       USE OCPCOMM4                                                        40.41
 !
+      IMPLICIT NONE
+!
 !
 !   --|-----------------------------------------------------------|--
 !     | Delft University of Technology                            |
@@ -1500,7 +1519,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1634,12 +1653,12 @@
 !
 !***********************************************************************
 !
-      INTEGER  IDDUM   ,ID      ,IS      ,ISSTOP
+      INTEGER  IENT, IDDUM   ,ID      ,IS      ,ISSTOP
 !
       REAL     FPM     ,UFRIC   ,THETA   ,THETAW  ,
      &         SWINEA  ,SIGMA   ,TEMP1   ,TEMP2   ,
      &         CTW     ,STW     ,COSDIF  ,                                40.41
-     &         TEMP3   ,FILTER
+     &         TEMP3   ,FILTER  ,ARGU
 !
       REAL    IMATRA(MDC,MSC)      ,
      &        PLWNDA(MDC,MSC,NPTST)                                       40.00
@@ -1727,6 +1746,8 @@
       USE SWCOMM4                                                         40.41
       USE OCPCOMM4                                                        40.41
 !
+      IMPLICIT NONE
+!
 !
 !   --|-----------------------------------------------------------|--
 !     | Delft University of Technology                            |
@@ -1739,7 +1760,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1877,7 +1898,7 @@
 !
 !***********************************************************************
 !
-      INTEGER  IDDUM ,ID    ,IS    ,ISSTOP
+      INTEGER  IENT, IDDUM ,ID    ,IS    ,ISSTOP
 !
       REAL     FPM   ,UFRIC ,THETA ,THETAW,SIGMA ,SWINEB,TEMP1,
      &         CTW   ,STW   ,COSDIF,                                      40.41
@@ -1960,6 +1981,8 @@
       USE SWCOMM4                                                         40.41
       USE OCPCOMM4                                                        40.41
 !
+      IMPLICIT NONE
+!
 !
 !   --|-----------------------------------------------------------|--
 !     | Delft University of Technology                            |
@@ -1972,7 +1995,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2144,6 +2167,12 @@
 !
       LOGICAL ANYWND(MDC)                                                 40.41
 !
+      INTEGER IENT , ITER,  IT,   J,  II
+      REAL ZTEN,  RATIO,  BETAMX,  TXHFR,  TYHFR,  CW2,  X1,  X2,
+     & ZARG1,  ZARG2,  GAMHF,  SIGMAX,  SIGHF1,  SIGHF2,  ZCNHF1,
+     & ZCNHF2,  AUX,  COS3,  ZAHF1,  ZAHF2,  FACHFR, FA, FB, FC, FD, FE,
+     & FCEN, FF1, FF2, FF3, DCEN, TAUNEW, XFAC2, BETA, ZLOG
+!
       SAVE IENT
       DATA IENT/0/
       IF (LTRACE) CALL STRACE (IENT,'SWIND4')
@@ -2505,6 +2534,8 @@
       USE SWCOMM4                                                         40.41
       USE OCPCOMM4                                                        40.41
 !
+      IMPLICIT NONE
+!
 !
 !   --|-----------------------------------------------------------|--
 !     | Delft University of Technology                            |
@@ -2517,7 +2548,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2641,9 +2672,9 @@
 !
 !***********************************************************************
 !
-      INTEGER  IDDUM  ,ID     ,IS     ,ISSTOP
+      INTEGER  IENT, IDDUM  ,ID     ,IS     ,ISSTOP
 !
-      REAL     UFRIC  ,THETA  ,THETAW ,SIGMA  ,SWINEB ,
+      REAL     UFRIC  ,THETA  ,THETAW ,SIGMA  ,SWINEB , TEMP3,
      &         CTW    ,STW    ,COSDIF ,                                   40.41
      &         USTAC1 ,USTAC2 ,COF1   ,COF2   ,COF3   ,COF4
 !
--- swancom4.ftn	2014-04-18 10:07:14.000000000 +0200
+++ swancom4.ftn	2015-02-04 11:53:04.000000000 +0100
@@ -71,7 +71,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -513,7 +513,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -706,7 +706,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1204,7 +1204,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1606,7 +1606,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2000,7 +2000,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2406,7 +2406,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2694,7 +2694,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2823,7 +2823,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3027,7 +3027,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3166,7 +3166,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3463,8 +3463,11 @@
               RINT = AUX1 / AUX2
               FT = PTRIAD(1) * C0 * CGO(IS,1) * RINT**2 * SINBPH
 
-!              SA(ID,IS) = MAX(0., FT * ( EM * EM - 2. * EM * E0 ))
-              SA(ID,IS) = MAX(0., FT * ( EDM * (EM - E0) - ED0 * EM ))    41.44
+              IF (ITRIAD.EQ.11) THEN
+                SA(ID,IS) = MAX(0., FT * ( EM * EM - 2. * EM * E0 ))
+              ELSE
+                SA(ID,IS) = MAX(0., FT * ( EDM * (EM - E0) - ED0 * EM ))  41.44
+              ENDIF
 
            END DO
         END DO
@@ -3543,7 +3546,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3942,7 +3945,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- swancom5.ftn	2014-04-18 10:07:14.000000000 +0200
+++ swancom5.ftn	2015-02-04 11:53:04.000000000 +0100
@@ -55,7 +55,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -106,7 +106,7 @@
 !
       INTEGER SWPDIR
       REAL    XCGRID(MXC,MYC), YCGRID(MXC,MYC),
-     &        RDX(10)        , RDY(10)
+     &        RDX(MICMAX)    , RDY(MICMAX)
 !
 !  6. Local variables
 !
@@ -261,7 +261,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -512,7 +512,7 @@
       REAL  ::  DEP2(MCGRD)         ,
      &          UX2(MCGRD)          ,
      &          UY2(MCGRD)          ,
-     &          RDX(10), RDY(10)                                          40.08
+     &          RDX(MICMAX), RDY(MICMAX)                                  40.08
 !
       LOGICAL   ANYBIN(MDC,MSC)     ,
      &          LOWEST, LOWBIN, HGHBIN
@@ -865,6 +865,8 @@
       USE OCPCOMM4                                                        40.41
       USE M_DIFFR                                                         40.21
 !
+      IMPLICIT NONE
+!
 !
 !   --|-----------------------------------------------------------|--
 !     | Delft University of Technology                            |
@@ -877,7 +879,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1043,7 +1045,7 @@
 !
 !************************************************************************
 !
-      INTEGER  IC    ,IS    ,ID    ,SWPDIR
+      INTEGER  IENT, IP, IC    ,IS    ,ID    ,SWPDIR
 !
       REAL     CAX(MDC,MSC,ICMAX)          ,
      &         CAY(MDC,MSC,ICMAX)          ,
@@ -1164,7 +1166,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1303,8 +1305,8 @@
       REAL  :: KWAVE(MSC,MICMAX)                                          40.22
       REAL  :: UX2(MCGRD)                  ,
      &         UY2(MCGRD)                  ,
-     &         RDX(10)                     ,                              40.08
-     &         RDY(10)                                                    40.08
+     &         RDX(MICMAX)                 ,                              40.08
+     &         RDY(MICMAX)                                                40.08
 !
 !        logical:
 !
@@ -1317,7 +1319,7 @@
 !
 !        ICUR    Indicator for current
 !        ICMAX   Maximum array size for the points of the molecule
-!        NSTATC  Indicator if computation is stationair
+!        NSTATC  Indicator if computation is stationary or not
 !        MXC     Maximum counter of gridppoints in x-direction
 !        MYC     Maximum counter of gridppoints in y-direction
 !        MSC     Maximum counter of relative frequency
@@ -1993,7 +1995,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2128,13 +2130,13 @@
       REAL  :: KWAVE(MSC,MICMAX)                                          40.22
       REAL  :: UX2(MCGRD)                  ,
      &         UY2(MCGRD)                  ,
-     &         RDX(10)                     ,                              40.08
-     &         RDY(10)                                                    40.08
+     &         RDX(MICMAX)                 ,                              40.08
+     &         RDY(MICMAX)                                                40.08
 !
 !     variables from common
 !
 !        ICUR    Indicator for current
-!        NSTATC  Indicator if computation is stationair
+!        NSTATC  Indicator if computation is stationary or not
 !        MXC     Maximum counter of gridppoints in x-direction
 !        MYC     Maximum counter of gridppoints in y-direction
 !        MSC     Maximum counter of relative frequency
@@ -2317,34 +2319,34 @@
 !                      2DY USING P4-P3
 
 !     *** @D/@X ***
-!      DHDX = 1.0*RDX(1) * (DLOC1-DLOC2) + 1.0*RDX(2) * (DLOC1-DLOC3) ! upwind scheme
-      DHDX = 0.5*RDX(1) * (DLOC5-DLOC2) + 0.5*RDX(2) * (DLOC4-DLOC3) ! centered scheme       40.59
+      DHDX = 1.0*RDX(1) * (DLOC1-DLOC2) + 1.0*RDX(2) * (DLOC1-DLOC3) ! upwind scheme
+!      DHDX = 0.5*RDX(1) * (DLOC5-DLOC2) + 0.5*RDX(2) * (DLOC4-DLOC3) ! centered scheme       40.59
 !     *** @D/@Y ***
-!      DHDY = 1.0*RDY(1) * (DLOC1-DLOC2) + 1.0*RDY(2) * (DLOC1-DLOC3) ! upwind scheme
-      DHDY = 0.5*RDY(1) * (DLOC5-DLOC2) + 0.5*RDY(2) * (DLOC4-DLOC3) ! centered scheme       40.59
+      DHDY = 1.0*RDY(1) * (DLOC1-DLOC2) + 1.0*RDY(2) * (DLOC1-DLOC3) ! upwind scheme
+!      DHDY = 0.5*RDY(1) * (DLOC5-DLOC2) + 0.5*RDY(2) * (DLOC4-DLOC3) ! centered scheme       40.59
 
       IF ( ICUR .EQ. 1 ) THEN  !           *** current is on ***
 !
 !     *** @Ux/@X ***
-!         DUXDX = 1.0*RDX(1) * (UXLOC1 - UXLOC2) +
-!     &           1.0*RDX(2) * (UXLOC1 - UXLOC3)
-         DUXDX = 0.5*RDX(1) * (UXLOC5 - UXLOC2) +
-     &           0.5*RDX(2) * (UXLOC4 - UXLOC3)                            40.59
+         DUXDX = 1.0*RDX(1) * (UXLOC1 - UXLOC2) +
+     &           1.0*RDX(2) * (UXLOC1 - UXLOC3)
+!         DUXDX = 0.5*RDX(1) * (UXLOC5 - UXLOC2) +
+!     &           0.5*RDX(2) * (UXLOC4 - UXLOC3)                            40.59
 !     *** @Ux/@Y ***
-!         DUXDY = 1.0*RDY(1) * (UXLOC1 - UXLOC2) +
-!     &           1.0*RDY(2) * (UXLOC1 - UXLOC3)
-         DUXDY = 0.5*RDY(1) * (UXLOC5 - UXLOC2) +
-     &           0.5*RDY(2) * (UXLOC4 - UXLOC3)                            40.59
+         DUXDY = 1.0*RDY(1) * (UXLOC1 - UXLOC2) +
+     &           1.0*RDY(2) * (UXLOC1 - UXLOC3)
+!         DUXDY = 0.5*RDY(1) * (UXLOC5 - UXLOC2) +
+!     &           0.5*RDY(2) * (UXLOC4 - UXLOC3)                            40.59
 !     *** @Uy/@X ***
-!         DUYDX = 1.0*RDX(1) * (UYLOC1 - UYLOC2) +
-!     &           1.0*RDX(2) * (UYLOC1 - UYLOC3)
-         DUYDX = 0.5*RDX(1) * (UYLOC5 - UYLOC2) +
-     &           0.5*RDX(2) * (UYLOC4 - UYLOC3)                            40.59
+         DUYDX = 1.0*RDX(1) * (UYLOC1 - UYLOC2) +
+     &           1.0*RDX(2) * (UYLOC1 - UYLOC3)
+!         DUYDX = 0.5*RDX(1) * (UYLOC5 - UYLOC2) +
+!     &           0.5*RDX(2) * (UYLOC4 - UYLOC3)                            40.59
 !     *** @Uy/@Y ***
-!         DUYDY = 1.0*RDY(1) * (UYLOC1 - UYLOC2) +
-!     &           1.0*RDY(2) * (UYLOC1 - UYLOC3)
-         DUYDY = 0.5*RDY(1) * (UYLOC5 - UYLOC2) +
-     &           0.5*RDY(2) * (UYLOC4 - UYLOC3)                            40.59
+         DUYDY = 1.0*RDY(1) * (UYLOC1 - UYLOC2) +
+     &           1.0*RDY(2) * (UYLOC1 - UYLOC3)
+!         DUYDY = 0.5*RDY(1) * (UYLOC5 - UYLOC2) +
+!     &           0.5*RDY(2) * (UYLOC4 - UYLOC3)                            40.59
 
        CAST3 = UXLOC1 * DHDX
        CAST4 = UYLOC1 * DHDY
@@ -2399,9 +2401,13 @@
         CLOC4=SPCSIG(IS)/KLOC4
         CLOC5=SPCSIG(IS)/KLOC5
 
+!       upwind scheme
+        DCDX = 1.0*RDX(1) * (CLOC1-CLOC2) + 1.0*RDX(2) * (CLOC1-CLOC3)    40.59
+        DCDY = 1.0*RDY(1) * (CLOC1-CLOC2) + 1.0*RDY(2) * (CLOC1-CLOC3)    40.59
+
 !       centered scheme
-        DCDX = 0.5*RDX(1) * (CLOC5-CLOC2) + 0.5*RDX(2) * (CLOC4-CLOC3)    40.59
-        DCDY = 0.5*RDY(1) * (CLOC5-CLOC2) + 0.5*RDY(2) * (CLOC4-CLOC3)    40.59
+!        DCDX = 0.5*RDX(1) * (CLOC5-CLOC2) + 0.5*RDX(2) * (CLOC4-CLOC3)    40.59
+!        DCDY = 0.5*RDY(1) * (CLOC5-CLOC2) + 0.5*RDY(2) * (CLOC4-CLOC3)    40.59
 
 !       *** coefficients for CAS -> function of IS only ***
 
@@ -2607,7 +2613,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2769,7 +2775,6 @@
       USE OCPCOMM4                                                        40.41
 !
 !
-!
 !   --|-----------------------------------------------------------|--
 !     | Delft University of Technology                            |
 !     | Faculty of Civil Engineering                              |
@@ -2781,7 +2786,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2923,7 +2928,7 @@
 !     Changed ICMAX to MICMAX, since MICMAX doesn't vary over gridpoint   40.22
       REAL  :: CAX(MDC,MSC,MICMAX) ,CAY(MDC,MSC,MICMAX)                   40.22
       REAL  :: IMATRA(MDC,MSC)    ,IMATDA(MDC,MSC)            ,
-     &         RDX(10)            ,RDY(10)                    ,           40.08
+     &         RDX(MICMAX)        ,RDY(MICMAX)                ,           40.08
      &         TRSCF(3)            ,                                      33.09
      &         OBREDF(MDC,MSC,2)                                         040697
       REAL  :: TRAC0(MDC,MSC,MTRNP)                                       40.85
@@ -2932,6 +2937,7 @@
       INTEGER  IDCMIN(MSC)                ,
      &         IDCMAX(MSC)                                                33.09
 !
+      INTEGER IENT
       SAVE IENT
       DATA IENT/0/
       IF (LTRACE) CALL STRACE (IENT,'STRSXY')
@@ -3001,7 +3007,7 @@
 !         *** the term FXY2 is known, store in IMATRA ***
 !         *** the term FXY1 is unknown, store in IMATDA ***
 !
-!         This business of doing rollback regardless of ITERMX is an artifact  40.08
+!         This business of doing rollback regardless of ITERMX was an artifact 40.08
 !         and has been removed. Thus, the code reverts to its form in v40.01   40.08
 !
           IF (NSTATC.EQ.1) THEN                                            40.00
@@ -3088,7 +3094,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3234,7 +3240,7 @@
 !     Changed ICMAX to MICMAX, since MICMAX doesn't vary over gridpoint   40.22
       REAL  :: CAX(MDC,MSC,MICMAX) ,CAY(MDC,MSC,MICMAX)                   40.22
       REAL  :: IMATRA(MDC,MSC)    ,IMATDA(MDC,MSC)            ,
-     &         RDX(10)            ,RDY(10)                    ,           40.08
+     &         RDX(MICMAX)        ,RDY(MICMAX)                ,           40.08
      &         XMU(5)             ,YMU(5)                                 40.08 33.10
       REAL  :: TRAC0(MDC,MSC,MTRNP)                                       40.85
       REAL  :: TRAC1(MDC,MSC,MTRNP)                                       40.85
@@ -3416,7 +3422,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3597,7 +3603,7 @@
       REAL  :: CGO(MSC,MICMAX)                                            33.08 40.22
       REAL  :: CAX(MDC,MSC,MICMAX) ,CAY(MDC,MSC,MICMAX)                   40.22
       REAL  :: IMATRA(MDC,MSC)    ,IMATDA(MDC,MSC)
-      REAL  :: RDX(10)            ,RDY(10)                                40.08
+      REAL  :: RDX(MICMAX)        ,RDY(MICMAX)                            40.08
 !     Changed ICMAX to MICMAX, since MICMAX doesn't vary over gridpoint   40.22
       REAL  :: CAX1(MDC,MSC,MICMAX),CAY1(MDC,MSC,MICMAX)                  33.08 40.22
       REAL  :: DCG, SPCDIR(MDC,6), DXX, DYY, DXY                          33.08
@@ -3870,7 +3876,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4005,7 +4011,7 @@
 !
 !****************************************************************
 !
-      INTEGER  IS      ,ID      ,IDDLOW  ,IDDTOP  ,IDDUM
+      INTEGER  IENT, IS      ,ID      ,IDDLOW  ,IDDTOP  ,IDDUM
 !
       REAL     DS      ,PNH     ,PN1     ,PN2     ,C1      ,C2      ,
      &         C3      ,A1      ,A3      ,PCD1    ,PCD2    ,RHS12   ,
@@ -4176,6 +4182,8 @@
       USE SWCOMM4                                                         40.41
       USE OCPCOMM4                                                        40.41
 !
+      IMPLICIT NONE
+!
 !
 !   --|-----------------------------------------------------------|--
 !     | Delft University of Technology                            |
@@ -4188,7 +4196,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4388,7 +4396,7 @@
 !
 !************************************************************************
 !
-      INTEGER  IS      ,ID      ,ISSTOP  ,
+      INTEGER  IENT, IS      ,ID      ,ISSTOP  ,
      &         IDDLOW  ,IDDTOP  ,IDDUM
 !
       REAL     FSA     ,FLEFT   ,FRGHT   ,DS      ,CFLMAX  ,CFLCEN  ,
@@ -4400,8 +4408,8 @@
      &         CAY(MDC,MSC,ICMAX)       ,
      &         AC2(MDC,MSC,MCGRD)       ,
      &         IMATRA(MDC,MSC)          ,
-     &         RDX(10)                  ,                                 40.08
-     &         RDY(10)                                                    40.08
+     &         RDX(MICMAX)              ,                                 40.08
+     &         RDY(MICMAX)                                                40.08
       REAL  :: TRAC0(MDC,MSC,MTRNP)                                       41.07
 !
       INTEGER  IDCMIN(MSC)              ,
@@ -4580,7 +4588,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4705,7 +4713,7 @@
 !
       LOGICAL  BIN1, BIN2, BIN3
 !
-      INTEGER  IS    ,ID    ,IIDM  ,IIDP  ,
+      INTEGER  IENT  ,IS    ,ID    ,IIDM  ,IIDP  ,
      &         ISSTOP,IDDUM
 !
       REAL     DD    ,PNH   ,PN1   ,PN2
@@ -4843,14 +4851,18 @@
       SUBROUTINE SPREDT (SWPDIR     ,AC2        ,CAX       ,
      &                   CAY        ,IDCMIN     ,IDCMAX    ,
      &                   ISSTOP     ,ANYBIN     ,
+     &                   XCGRID     ,YCGRID     ,                         41.53
      &                   RDX        ,RDY        ,OBREDF    )              40.00
 !
 !****************************************************************
 !
+      USE SWCOMM2                                                         41.53
       USE SWCOMM3                                                         40.41
       USE SWCOMM4                                                         40.41
       USE OCPCOMM4                                                        40.41
 !
+      IMPLICIT NONE
+!
 !
 !   --|-----------------------------------------------------------|--
 !     | Delft University of Technology                            |
@@ -4863,7 +4875,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4882,10 +4894,11 @@
 !
 !
 !     0. Authors
-
+!
 !     40.00, 40.13: Nico Booij
 !     40.41: Marcel Zijlema
-
+!     41.53: Marcel Zijlema
+!
 !     1. UPDATE
 !
 !        40.00, Aug 98: introduction of obstacle reduction factor to
@@ -4894,6 +4907,7 @@
 !        40.13, Aug 01: modification of action densities is skipped
 !                       in case of Mode Noupdate
 !        40.41, Oct 04: common blocks replaced by modules, include files removed
+!        41.53, Oct 14: correction curvilinear grid
 !
 !     2. PURPOSE
 !
@@ -4977,6 +4991,8 @@
 !       IDCMIN 1D    frequency dependent counters in case of a current
 !       IDCMAX 1D    frequency dependent counters in case of a current
 !       ANYBIN 2D    Determines if a bin fall within a sweep
+!       XCGRID       coordinates of computational grid in x-direction
+!       YCGRID       coordinates of computational grid in y-direction
 !
 !     5. SUBROUTINES CALLING
 !
@@ -5013,26 +5029,97 @@
       INTEGER  IS    ,ID    ,
      &         SWPDIR,IDDUM ,ISSTOP                                       40.00
 !
-      REAL     FAC_A ,FAC_B
+      REAL     FAC_A ,FAC_B, WEIG1, WEIG2, TCF1, TCF2, CDEN, CNUM
 !
       REAL  :: AC2(MDC,MSC,MCGRD)                                         30.21
 !     Changed ICMAX to MICMAX, since MICMAX doesn't vary over gridpoint   40.22
       REAL  :: CAX(MDC,MSC,MICMAX)                                        40.22
       REAL  :: CAY(MDC,MSC,MICMAX)                                        40.22
-      REAL  :: RDX(10),  RDY(10)        ,                                 40.08 30.21
+      REAL  :: RDX(MICMAX),  RDY(MICMAX),                                 40.08 30.21
      &         OBREDF(MDC,MSC,2)                                          40.00
+      REAL  :: XCGRID(MXC,MYC), YCGRID(MXC,MYC)                           41.53
 !
       INTEGER  IDCMIN(MSC)              ,
      &         IDCMAX(MSC)
 !
       LOGICAL  ANYBIN(MDC,MSC)
 !
+      INTEGER  IDIR, IDCUM, IDMIN, IDMAX, NCURID, NID(4)                  41.53
+      REAL     IDX, IDY, CLAT                                             41.53
+!
+      INTEGER IENT
       SAVE IENT
       DATA IENT/0/
       IF (LTRACE) CALL STRACE (IENT,'SPREDT')
 !
-        DO 200 IS = 1, ISSTOP
-          DO 190 IDDUM = IDCMIN(IS), IDCMAX(IS)
+      IF ( OPTG.EQ.3 .AND. CCURV ) THEN
+!
+!        --- curvilinear grid                                             41.53
+!            consider the equation on a rectangular grid                  41.53
+!            so that all bins will be filled                              41.53
+!
+        IDX=1./(XCGRID(IXCGRD(1),IYCGRD(1))-XCGRID(IXCGRD(2),IYCGRD(2)))
+        IDY=1./(YCGRID(IXCGRD(1),IYCGRD(1))-YCGRID(IXCGRD(3),IYCGRD(3)))
+!
+        IF ( KSPHER.GT.0 ) THEN
+           CLAT = COS(DEGRAD*(YCGRID(IXCGRD(1),IYCGRD(1))+YOFFS))
+           IDX  = IDX / (CLAT * LENDEG)
+           IDY  = IDY / LENDEG
+        ENDIF
+!
+        IDCUM = 0
+        DO IDIR = 1, 4
+           NID(IDIR) = (MDC*IDIR)/4 - IDCUM
+           IDCUM     = (MDC*IDIR)/4
+        ENDDO
+        !
+        ! determine loop bounds in spectral space for current sweep
+        !
+        IDMIN = MDC+1
+        IDMAX = 0
+        !
+        IDIR   = 1
+        NCURID = 0
+        !
+        DO ID = 1, MDC
+           !
+           IF ( IDIR.EQ.SWPDIR ) THEN
+              IDMIN = MIN(ID,IDMIN)
+              IDMAX = MAX(ID,IDMAX)
+           ENDIF
+           NCURID = NCURID + 1
+           !
+           IF ( NCURID.GE.NID(IDIR) ) THEN
+              IDIR   = IDIR + 1
+              NCURID = 0
+           ENDIF
+           !
+        ENDDO
+!
+        DO IS = 1, MSC
+          DO ID = IDMIN, IDMAX
+!
+             IF ( NUMOBS.GT.0 ) THEN
+                TCF1 = OBREDF(ID,IS,1)
+                TCF2 = OBREDF(ID,IS,2)
+             ELSE
+                TCF1 = 1.
+                TCF2 = 1.
+             ENDIF
+!
+             CDEN = IDX * CAX(ID,IS,1) + IDY * CAY(ID,IS,1)
+!
+             CNUM = IDX * CAX(ID,IS,2) * TCF1 * AC2(ID,IS,KCGRD(2)) +
+     &              IDY * CAY(ID,IS,3) * TCF2 * AC2(ID,IS,KCGRD(3))
+!
+             IF (ACUPDA) AC2(ID,IS,KCGRD(1)) = CNUM / CDEN
+!
+          ENDDO
+        ENDDO
+!
+      ELSE
+        DO IS = 1, ISSTOP
+          DO IDDUM = IDCMIN(IS), IDCMAX(IS)
             ID = MOD ( IDDUM - 1 + MDC , MDC ) + 1
             IF ( ANYBIN(ID,IS) ) THEN
 !
@@ -5058,14 +5145,15 @@
      &           AC2(ID,IS,KCGRD(1)) = MAX ( 0. , (FAC_A + FAC_B))        30.21
 !
             END IF
- 190      CONTINUE
- 200    CONTINUE
+          END DO
+        END DO
+      END IF
 !
       IF ( ITEST .GE. 140 .AND. TESTFL ) THEN
         WRITE(PRINTF,6019) KCGRD(1), SWPDIR
  6019   FORMAT(' PREDT : POINT INDX  SWPDIR         :',2I5)
-        DO 610 IS = 1, ISSTOP
-          DO 600 IDDUM = IDCMIN(IS)-1, IDCMAX(IS)+1
+        DO IS = 1, ISSTOP
+          DO IDDUM = IDCMIN(IS)-1, IDCMAX(IS)+1
             ID = MOD ( IDDUM - 1 + MDC , MDC ) + 1
             WRITE (PRINTF,6020) IS, ID, AC2(ID,IS,KCGRD(1)),
      &                          AC2(ID,IS,KCGRD(2)),
@@ -5073,8 +5161,8 @@
      &                          ANYBIN(ID,IS)
  6020       FORMAT ('       : IS ID AC2 AC2(2) AC2(3) ANYBIN   :',
      &              2I5,3(E12.4),L4)
- 600      CONTINUE
- 610    CONTINUE
+          END DO
+        END DO
       END IF
 !
 !     End of the subroutine SPREDT
@@ -5104,7 +5192,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5320,6 +5408,8 @@
 !
       USE SWCOMM3                                                         40.41
 !
+      IMPLICIT NONE
+!
 !
 !   --|-----------------------------------------------------------|--
 !     | Delft University of Technology                            |
@@ -5332,7 +5422,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5455,6 +5545,10 @@
      &        IMAT5L(MDC,MSC)           ,                                 40.85
      &        IMAT6U(MDC,MSC)                                             40.85
 !
+      REAL  ARADSTR, DSDD, SDSDD, S1, ACT1, S2
+      REAL  ACT2, S3, ACT3, ACT4, ACT5, ACONTR
+      INTEGER ISC, IDC, IDM, IDP
+!
       LOGICAL  ANYBIN(MDC,MSC)
       INTEGER, SAVE :: IENT=0
       CALL STRACE (IENT, 'ADDDIS')
@@ -5571,7 +5665,12 @@
       TSXSPS(KCGRD(1)) = TSXSPS(KCGRD(1)) + ATRANSP(3)     ! sigma-propagation    40.85
       TRANXY(KCGRD(1)) = TRANXY(KCGRD(1)) + SUM(ATRANSP)   ! total propagation    40.85
 !
-      RADSXY(KCGRD(1)) = RADSXY(KCGRD(1)) + ARADSTR        ! radiation stress     40.85
+!       energy transfer between waves and currents due to radiation stress, see page 439 of
+!       the ICCE paper of Holthuijsen, L.H., Zijlema, M. and Van der Ham, P.J. (2009)
+!       Wave physics in a tidal inlet, in: J.M. Smith (Ed.), Proc. 31st Int. Conf. on Coast. Engng.
+!       ASCE, World Scientific Publishing, Singapore, 437-448
+!
+      RADSXY(KCGRD(1)) = RADSXY(KCGRD(1)) + ARADSTR                       40.85
 !
       IMATLA = 0.
       IMATUA = 0.
@@ -5608,7 +5707,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5918,7 +6017,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanCompdata.ftn90	2014-04-18 10:06:59.000000000 +0200
+++ SwanCompdata.ftn90	2015-02-04 11:52:59.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanCompUnstruc.ftn90	2014-04-18 10:07:14.000000000 +0200
+++ SwanCompUnstruc.ftn90	2015-02-04 11:53:04.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -801,8 +801,8 @@
                         goto 20
                      endif
  10                  if ( lpredt ) then
-                        call SPREDT (swpdir, ac2   , cax, cay, idcmin, idcmax, &
-                                     isstop, anybin, rdx, rdy, obredf)
+                        call SPREDT (swpdir, ac2   , cax  , cay  , idcmin, idcmax,        &
+                                     isstop, anybin, dummy, dummy, rdx   , rdy   , obredf)
                         lpredt = .false.
                      endif
                      !
@@ -925,7 +925,8 @@
                                       disc1               , genc0               , genc1               , redc0               , &
                                       redc1               , xis                 , compda(1,JFRC2)     , it                  , &
                                       compda(1,JNPLA2)    , compda(1,JTURB2)    , compda(1,JMUDL2)    ,                       &
-                                      compda(1,JURSEL)    , anybin              , reflso              )
+                                      compda(1,JURSEL)    , anybin              , reflso                                      &
+                                                                                                                            )
 !TIMG                        call SWTSTO(117)
                         !
                      endif
@@ -1361,7 +1362,7 @@
  103 format (' ITER  ',i4,'    GRWMX ',e12.4,'    ALFA   ',e12.4)
  104 format (' IWIND ',i4,'    IWCAP ',i4   ,'            IQUAD  ',i4)
  105 format (' ISURF ',i4,'    IBOT  ',i4   ,'            ITRIAD ',i4)
- 106 format (' IVEG  ',i4,'    ITURBV',i4,'    IMUD  ',i4,/)
+ 106 format (' IVEG  ',i4,'    ITURBV',i4   ,'            IMUD   ',i4,/)
  107 format (' Test points :',2i5)
  108 format (' Number of active points = ',i6,' (fillings-degree: ',f6.2,' %)')
  110 format ('+time ', a18, ', step ',i6, '; iteration ',i4, '; sweep ',i3)
--- SwanComputeForce.ftn90	2014-04-18 10:07:00.000000000 +0200
+++ SwanComputeForce.ftn90	2015-02-04 11:53:00.000000000 +0100
@@ -12,7 +12,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanConvAccur.ftn90	2014-04-18 10:07:00.000000000 +0200
+++ SwanConvAccur.ftn90	2015-02-04 11:53:00.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanConvStopc.ftn90	2014-04-18 10:07:00.000000000 +0200
+++ SwanConvStopc.ftn90	2015-02-04 11:53:00.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -253,7 +253,7 @@
     !
     !$omp barrier
     !$omp single
-    if ( npacc > 0. ) accur = npacc*100./nwetp
+    if ( npacc > 0. ) accur = ceiling(npacc*10000./nwetp)/100.
     !$omp end single
     !
  11 format(13x,'dHabs          ','dHrel          ','Curvature H    ','dTabs          ','dTrel          ','Curvature T    ')
--- SwanCreateEdges.ftn90	2014-04-18 10:07:01.000000000 +0200
+++ SwanCreateEdges.ftn90	2015-02-04 11:53:00.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanCrossObstacle.ftn90	2014-04-18 10:07:01.000000000 +0200
+++ SwanCrossObstacle.ftn90	2015-02-04 11:53:00.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanDiffPar.ftn90	2014-04-18 10:07:01.000000000 +0200
+++ SwanDiffPar.ftn90	2015-02-04 11:53:00.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanDispParm.ftn90	2014-04-18 10:07:01.000000000 +0200
+++ SwanDispParm.ftn90	2015-02-04 11:53:00.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- swan.edt	2014-04-18 10:06:53.000000000 +0200
+++ swan.edt	2015-02-04 11:52:57.000000000 +0100
@@ -6,7 +6,7 @@
 !   SET  [level]  [nor]  [depmin]  [maxmes]                                 &
 !        [maxerr]  [grav]  [rho] [cdcap] [inrhog]                           &
 !        [hsrerr]  CARTesian|NAUTical  [pwtail]                             &
-!        [froudmax]  [sort]  [printf]  [prtest]
+!        [froudmax]  [sort]  CURV  [printf]  [prtest]
 !
 !   MODE  / STATIONARY \  / TWODimensional
 !         \ DYNAMIC    /  \ ONEDimensional
@@ -15,7 +15,7 @@
 !                \ SPHErical      CCM|QC  /
 !
 !   CGRID  / REGular [xpc] [ypc] [alpc] [xlenc] [ylenc] [mxc] [myc] \
-!         <  CURVilinear [mxc] [myc]  (EXC [xexc] [yexc])            >      &
+!         <  CURVilinear [mxc] [myc]  (EXC [xexc] [yexc]) [alpc]     >      &
 !          \ UNSTRUCtured                                           /
 !
 !          / CIRcle               \
--- SwanFindObstacles.ftn90	2014-04-18 10:07:01.000000000 +0200
+++ SwanFindObstacles.ftn90	2015-02-04 11:53:00.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanFindPoint.ftn90	2014-04-18 10:07:02.000000000 +0200
+++ SwanFindPoint.ftn90	2015-02-04 11:53:00.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanGridCell.ftn90	2014-04-18 10:07:02.000000000 +0200
+++ SwanGridCell.ftn90	2015-02-04 11:53:00.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanGriddata.ftn90	2014-04-18 10:07:02.000000000 +0200
+++ SwanGriddata.ftn90	2015-02-04 11:53:00.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanGridFace.ftn90	2014-04-18 10:07:02.000000000 +0200
+++ SwanGridFace.ftn90	2015-02-04 11:53:00.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanGridobjects.ftn90	2014-04-18 10:07:02.000000000 +0200
+++ SwanGridobjects.ftn90	2015-02-04 11:53:00.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanGridTopology.ftn90	2014-04-18 10:07:03.000000000 +0200
+++ SwanGridTopology.ftn90	2015-02-04 11:53:00.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanGridVert.ftn90	2014-04-18 10:07:03.000000000 +0200
+++ SwanGridVert.ftn90	2015-02-04 11:53:01.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanGSECorr.ftn90	2014-04-18 10:07:03.000000000 +0200
+++ SwanGSECorr.ftn90	2015-02-04 11:53:01.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- swanhcat.ftn	2014-04-18 10:07:14.000000000 +0200
+++ swanhcat.ftn	2015-02-04 11:53:04.000000000 +0100
@@ -16,7 +16,7 @@
 !     hcat.nml file.
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanInitCompGrid.ftn90	2014-04-18 10:07:03.000000000 +0200
+++ SwanInitCompGrid.ftn90	2015-02-04 11:53:01.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanInterpolateAc.ftn90	2014-04-18 10:07:04.000000000 +0200
+++ SwanInterpolateAc.ftn90	2015-02-04 11:53:01.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanInterpolateOutput.ftn90	2014-04-18 10:07:04.000000000 +0200
+++ SwanInterpolateOutput.ftn90	2015-02-04 11:53:01.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanInterpolatePoint.ftn90	2014-04-18 10:07:04.000000000 +0200
+++ SwanInterpolatePoint.ftn90	2015-02-04 11:53:01.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanIntgratSpc.ftn90	2014-04-18 10:07:04.000000000 +0200
+++ SwanIntgratSpc.ftn90	2015-02-04 11:53:01.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- swanmain.ftn	2014-04-18 10:07:14.000000000 +0200
+++ swanmain.ftn	2015-02-04 11:53:04.000000000 +0100
@@ -46,7 +46,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -119,7 +119,8 @@
 
 !     --- start SWAN run
 
-      CALL SWMAIN                                                         40.31 34.01
+!     the main SWAN routine is called from the ADCIRC driver
+!NADC      CALL SWMAIN                                                         40.31 34.01
 
 999   CONTINUE
 
@@ -172,7 +173,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -788,7 +789,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -947,7 +948,7 @@
       VERTXT = BLANK                                                      40.03
       VERNUM = 41.01
       WRITE (VERTXT, '(F5.2)') VERNUM                                     40.03
-!      CALL BUGFIX ('A')
+      CALL BUGFIX ('A')
 !
       CALL OCPINI ('swaninit', .TRUE.,INERR)                              34.01
       IF (INERR.GT.0) RETURN                                              34.01
@@ -1056,6 +1057,7 @@
       FULCIR = .TRUE.
       SPDIR1 = 0.
       asort  = -999.                                                      41.48
+      CCURV  = .FALSE.                                                    41.53
 !     number of points needed in computational stencil:
       ICMAX  = 3
 !     ***** numerical scheme *****
@@ -1080,7 +1082,9 @@
       IREFR  = 1                                                          40.02
       ITFRE  = 1
       IWIND  = 0
-      IDRAG  = 2                                                          41.49 41.33
+!     when coupled with ADCIRC, the default is to use ADCIRC drag formulation
+!NADC      IDRAG  = 2                                                          41.49 41.33
+!ADC      IDRAG  = 0
       IGEN   = 3                                                          32.06
       IQUAD  = 2                                                          30.72
       IWCAP  = 1                                                          21/MAY
@@ -2450,7 +2454,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2784,7 +2788,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3167,7 +3171,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3688,7 +3692,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4091,7 +4095,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4220,7 +4224,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4350,7 +4354,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4525,7 +4529,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4624,7 +4628,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4748,7 +4752,7 @@
 !
 !     *** Check formulation for whitecapping ***
 !
-      IF ( IWCAP.GT.7 ) THEN
+      IF ( IWCAP.GT.8 ) THEN
          WRITE (MSGSTR, '(A,I2,A)')
      &               'Unknown method for whitecapping (IWCAP=',IWCAP,')'
          CALL MSGERR( 1, TRIM(MSGSTR) )
@@ -4841,7 +4845,8 @@
 !     used in the CGRID command. This error should be corrected
 !     in the future
 !
-      IF (IWIND.EQ.3 .OR. IWIND.EQ.4) THEN                                30.60
+      IF (IWIND.EQ.3 .OR. IWIND.EQ.4
+     &                              ) THEN                                30.60
         IF (IQUAD .EQ. 0) THEN
           CALL MSGERR(2,'Quadruplets should be activated when SWAN  ')    30.60
           CALL MSGERR(2,'is running in a third generation mode and  ')    30.60
@@ -4966,7 +4971,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5291,7 +5296,7 @@
 
 !     field 4: friction coeff.
       IF (IFLDYN(4) .EQ. 1) THEN
-        CALL FLFILE ( 4, 0, FRIC, 0.,                                     40.31
+        CALL FLFILE ( 4, 0, FRIC, (/0./),                                 40.31
      &               0, JFRC2, JFRC3, 0, 0, 0,
      &               1., 0.,                                              40.31 30.90
      &               COMPDA, XCGRID, YCGRID,
@@ -5318,7 +5323,7 @@
 
 !     field 7: water level
       IF (IFLDYN(7) .EQ. 1) THEN
-        CALL FLFILE ( 7, 0, WLEVL, 0.,                                    40.31
+        CALL FLFILE ( 7, 0, WLEVL, (/0./),                                40.31
      &               JWLV1, JWLV2, JWLV3, 0, 0, 0,
      &               1., 0.,                                              40.31 30.90
      &               COMPDA, XCGRID, YCGRID,
@@ -5468,7 +5473,7 @@
 
 !     field 11: field containing number of plants per square meter
       IF (IFLDYN(11) .EQ. 1) THEN
-        CALL FLFILE (11, 0, NPLAF, 0.,
+        CALL FLFILE (11, 0, NPLAF, (/0./),
      &               0, JNPLA2, JNPLA3, 0, 0, 0,
      &               1., 0.,
      &               COMPDA, XCGRID, YCGRID,
@@ -5495,7 +5500,7 @@
 
 !     field 12: field containing turbulent viscosity
       IF (IFLDYN(12) .EQ. 1) THEN
-        CALL FLFILE (12, 0, TURBF, 0.,
+        CALL FLFILE (12, 0, TURBF, (/0./),
      &               0, JTURB2, JTURB3, 0, 0, 0,
      &               1., 0.,
      &               COMPDA, XCGRID, YCGRID,
@@ -5522,7 +5527,7 @@
 
 !     field 13: field containing fluid mud layer
       IF (IFLDYN(13) .EQ. 1) THEN
-        CALL FLFILE (13, 0, MUDLF, 0.,
+        CALL FLFILE (13, 0, MUDLF, (/0./),
      &               JMUDL1, JMUDL2, JMUDL3, 0, 0, 0,
      &               1., 0.,
      &               COMPDA, XCGRID, YCGRID,
@@ -5580,7 +5585,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -6182,7 +6187,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -6311,8 +6316,8 @@
 !
 !  8. Subroutines used
 !
-!       GAMMA (in SWANSER)
-      REAL :: GAMMA                                                       40.03
+!       GAMMAF (in SWANSER)
+      REAL :: GAMMAF                                                      40.03
       LOGICAL EQREAL                                                      40.41
 !
 !  9. Subroutines calling
@@ -6423,7 +6428,7 @@
           IF (MS.GT.10.) THEN
             CTOT = SQRT(MS/(2.*PI)) * (1. + 0.25/MS)                      30.81 40.00
           ELSE
-            CTOT = 2.**MS * (GAMMA(1.+0.5*MS))**2 / (PI * GAMMA(1.+MS))   40.00
+            CTOT = 2.**MS * (GAMMAF(1.+0.5*MS))**2 / (PI*GAMMAF(1.+MS))   40.00
           ENDIF
           DSUM = 0.
           DO ID = 1, MDC
@@ -6614,7 +6619,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -6995,7 +7000,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -7291,7 +7296,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanMaxOverNodes.ftn90	2014-04-18 10:07:05.000000000 +0200
+++ SwanMaxOverNodes.ftn90	2015-02-04 11:53:01.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanMinOverNodes.ftn90	2014-04-18 10:07:05.000000000 +0200
+++ SwanMinOverNodes.ftn90	2015-02-04 11:53:01.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- swanout1.ftn	2014-04-18 10:07:14.000000000 +0200
+++ swanout1.ftn	2015-02-04 11:53:04.000000000 +0100
@@ -48,7 +48,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -425,8 +425,16 @@
 !
 !       ***** table output *****
         IF (RTYPE(1:3) .EQ. 'TAB') THEN
-          CALL SWTABP ( RTYPE, CORQ%OQI, CORQ%IVTYP, SNAME,               40.31
+!NPUN!NCF          IF (PARLL.AND.(RTYPE.EQ.'TABC')) THEN
+!PUN!NCF          IF (MNPROC>1.AND.(RTYPE.EQ.'TABC')) THEN
+!NCF!            --- use "block" intermediate file facility to pass data between cores
+!NCF             CALL SWBLKP ( CORQ%OQI, CORQ%IVTYP, MIP, 1, VOQR,
+!NCF     &                     VOQ(1), IONOD )
+!NCF          ELSE
+!NCF             CALL SWTABP ( RTYPE, CORQ%OQI, CORQ%OQR, CORQ%IVTYP, SNAME,
+!NNCF          CALL SWTABP ( RTYPE, CORQ%OQI, CORQ%IVTYP, SNAME,               40.31
      &                  MIP, VOQR, VOQ(1), IONOD )                        40.51 40.31
+!NCF          ENDIF
           IF (STPNOW()) RETURN                                            34.01
           GOTO 68                                                         40.00
         ENDIF
@@ -489,7 +497,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -817,7 +825,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1086,7 +1094,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1400,6 +1408,7 @@
       USE SwanGridobjects                                                 40.91
 !PUN      USE SIZES
 !
+      IMPLICIT NONE
 !
 !
 !   --|-----------------------------------------------------------|--
@@ -1413,7 +1422,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1514,6 +1523,11 @@
 !PUN      LOGICAL    STPNOW
       LOGICAL    CROSS(4,MIP)                                             40.86
       LOGICAL, ALLOCATABLE :: LTMP(:)                                     40.91
+!
+      INTEGER MIP,IENT,JJ,IVXP,IVYP,IVDIST,IP,JVQX,JVQY,
+     &        KK, IXB, IXE, IYB, IYE, IX, IY
+      REAL UXLOC,UYLOC,RDIST,RDX,RDY,RR,UBLOC,F1,RTMP,XP1,YP1
+!
       type(verttype), dimension(:), pointer :: vert                       40.91
       SAVE IENT
       DATA IENT /0/
@@ -2639,7 +2653,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2903,7 +2917,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3044,6 +3058,8 @@
       INTEGER    VOQR(*)        ,BKC           ,IVOTP(NVOTP)      ,
      &           KGRPNT(MXC,MYC)                                          30.21
 !
+      REAL, ALLOCATABLE :: FLUX(:,:,:), FLOC(:,:)
+!
       LOGICAL    OQPROC(*), EQREAL                                        30.72
       LOGICAL :: EXCPT     ! if true value in point is undefined          40.86
       SAVE IENT, IVOTP
@@ -3052,6 +3068,21 @@
      &            42, 43, 44, 47, 48, 53, 58, 59, 71/                     41.15 40.64 40.51 40.41 40.00
       CALL STRACE (IENT, 'SWOEXA')
 !
+!     in case of transport of energy, compute the energy flux in all grid points
+!     (energy flux will then be interpolated at output points!)
+!
+      IF (OQPROC(15).OR.OQPROC(19)) THEN
+         IF(.NOT.ALLOCATED(FLUX)) ALLOCATE(FLUX(MDC,MSC,MCGRD))
+         IF(.NOT.ALLOCATED(FLOC)) ALLOCATE(FLOC(MDC,MSC))
+         DO IP=1, MCGRD
+            DEPLOC = DEPXY(IP)
+            CALL KSCIP1 (MSC, SPCSIG, DEPLOC, WK, CG, NE, NED)
+            DO IS=1, MSC
+               FLUX(:,IS,IP) = CG(IS)*AC2(:,IS,IP)
+            ENDDO
+         ENDDO
+      ENDIF
+!
 !     loop over all output points
 !
       DO 800 IP=1,MIP
@@ -3076,19 +3107,25 @@
         IF (OPTG.NE.5) THEN                                               40.80
            CALL SWOINA (XC(IP), YC(IP), AC2, ACLOC, KGRPNT, DEPXY,        40.86 30.50
      &                  CROSS(1,IP), EXCPT)                               40.86
+           IF (OQPROC(15).OR.OQPROC(19))
+     &        CALL SWOINA (XC(IP), YC(IP), FLUX, FLOC, KGRPNT, DEPXY,
+     &                     CROSS(1,IP), EXCPT)
         ELSE                                                              40.80
            IF (.NOT.LCOMPGRD) THEN
               IF (.NOT.EQREAL(VOQ(IP,1),OVEXCV(1))) XP=VOQ(IP,1)-XOFFS    40.80
               IF (.NOT.EQREAL(VOQ(IP,2),OVEXCV(2))) YP=VOQ(IP,2)-YOFFS    40.80
               CALL SwanInterpolateAc ( ACLOC, XP, YP, AC2, EXCPT )        40.80
+              IF (OQPROC(15).OR.OQPROC(19))
+     &           CALL SwanInterpolateAc ( FLOC, XP, YP, FLUX, EXCPT )
            ELSE
               ACLOC(:,:) = AC2(:,:,IP)
+              IF (OQPROC(15).OR.OQPROC(19)) FLOC(:,:) = FLUX(:,:,IP)
               EXCPT = .FALSE.
            ENDIF
         ENDIF                                                             40.80
         IF (EXCPT) GOTO 700                                               40.86
 !
-!       Coefficients for high frequency tail
+!       coefficient for high frequency tail
 !
         EFTAIL = 1. / (PWTAIL(1) - 1.)
 !
@@ -3744,9 +3781,8 @@
                   DSIG = 0.5 * (SPCSIG(ISIGM+1) - SPCSIG(ISIGM-1))        30.72
                 ENDIF
                 SIG2 = SPCSIG(ISIGM)                                      30.72
-                CS   = CG(ISIGM)*SIG2
                 DO ID=1,MDC
-                   CGE = DSIG * CS * ACLOC(ID,ISIGM)
+                   CGE = DSIG * SIG2 * FLOC(ID,ISIGM)
                    CEX = CEX + CGE * SPCDIR(ID,2)
                    CEY = CEY + CGE * SPCDIR(ID,3)
                    IF (ICUR.EQ.1) THEN
@@ -3762,10 +3798,10 @@
               IF (ICUR.EQ.1)                                              40.87
      &           ETOT=SwanIntgratSpc(0.,FMIN, FMAX, SPCSIG, SPCDIR(1,1),  40.87
      &                               WK, ECS, 0., 0., ACLOC, 1)           40.87
-              CEX = SwanIntgratSpc(1., FMIN, FMAX, SPCSIG, SPCDIR(1,1),   40.87
-     &                             CG, SPCDIR(1,2), 0., 0., ACLOC, 4)     40.87
-              CEY = SwanIntgratSpc(1., FMIN, FMAX, SPCSIG, SPCDIR(1,1),   40.87
-     &                             CG, SPCDIR(1,3), 0., 0., ACLOC, 4)     40.87
+              CEX = SwanIntgratSpc(0., FMIN, FMAX, SPCSIG, SPCDIR(1,1),   40.87
+     &                             CG, SPCDIR(1,2), 0., 0., FLOC, 1)      40.87
+              CEY = SwanIntgratSpc(0., FMIN, FMAX, SPCSIG, SPCDIR(1,1),   40.87
+     &                             CG, SPCDIR(1,3), 0., 0., FLOC, 1)      40.87
            ENDIF                                                          40.87
 !
            IF (ICUR.EQ.1) THEN
@@ -3818,9 +3854,8 @@
                   DSIG = 0.5 * (SPCSIG(ISIGM+1) - SPCSIG(ISIGM-1))        30.72
                 ENDIF
                 SIG2 = SPCSIG(ISIGM)                                      30.72
-                CS   = CG(ISIGM)*SIG2
                 DO ID=1,MDC
-                   CGE = DSIG * CS * ACLOC(ID,ISIGM)
+                   CGE = DSIG * SIG2 * FLOC(ID,ISIGM)
                    CEX = CEX + CGE * SPCDIR(ID,2)
                    CEY = CEY + CGE * SPCDIR(ID,3)
                    IF (ICUR.EQ.1) THEN
@@ -3836,10 +3871,10 @@
               IF (ICUR.EQ.1)                                              40.87
      &           ETOT=SwanIntgratSpc(0.,FMIN, FMAX, SPCSIG, SPCDIR(1,1),  40.87
      &                               WK, ECS, 0., 0., ACLOC, 1)           40.87
-              CEX = SwanIntgratSpc(1., FMIN, FMAX, SPCSIG, SPCDIR(1,1),   40.87
-     &                             CG, SPCDIR(1,2), 0., 0., ACLOC, 4)     40.87
-              CEY = SwanIntgratSpc(1., FMIN, FMAX, SPCSIG, SPCDIR(1,1),   40.87
-     &                             CG, SPCDIR(1,3), 0., 0., ACLOC, 4)     40.87
+              CEX = SwanIntgratSpc(0., FMIN, FMAX, SPCSIG, SPCDIR(1,1),   40.87
+     &                             CG, SPCDIR(1,2), 0., 0., FLOC, 1)      40.87
+              CEY = SwanIntgratSpc(0., FMIN, FMAX, SPCSIG, SPCDIR(1,1),   40.87
+     &                             CG, SPCDIR(1,3), 0., 0., FLOC, 1)      40.87
               CEX = CEX/DDIR                                              40.87
               CEY = CEY/DDIR                                              40.87
            ENDIF                                                          40.87
@@ -4407,6 +4442,8 @@
 !
  800  CONTINUE
 !
+      IF (ALLOCATED(FLUX)) DEALLOCATE(FLUX)
+      IF (ALLOCATED(FLOC)) DEALLOCATE(FLOC)
       RETURN
 !     end of subroutine SWOEXA
       END
@@ -4432,7 +4469,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4652,7 +4689,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- swanout2.ftn	2014-04-18 10:07:14.000000000 +0200
+++ swanout2.ftn	2015-02-04 11:53:04.000000000 +0100
@@ -37,7 +37,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -345,7 +345,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -572,7 +572,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -697,8 +697,9 @@
       END
 !***********************************************************************
 !                                                                      *
-      SUBROUTINE SWTABP (RTYPE , OQI  , IVTYP, PSNAME, MIP, VOQR, VOQ,    40.31
-     &                   IONOD)                                           40.51
+!NCF      SUBROUTINE SWTABP (RTYPE , OQI  , OQR , IVTYP, PSNAME, MIP, VOQR,
+!NNCF      SUBROUTINE SWTABP (RTYPE , OQI  , IVTYP, PSNAME, MIP, VOQR,         40.31
+     &                   VOQ, IONOD)                                      40.51
 !                                                                      *
 !***********************************************************************
 
@@ -711,6 +712,9 @@
       USE OUTP_DATA                                                       40.13
       USE TIMECOMM                                                        40.41
       USE M_PARALL                                                        40.51
+!NCF      USE swn_outnc, only: swn_outnc_openblockfile,
+!NCF     &                     swn_outnc_appendblock,
+!NCF     &                     swn_outnc_close_on_end
 !PUN      USE SIZES, ONLY: MYPROC, MNPROC
 !
 !
@@ -725,7 +729,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -804,6 +808,7 @@
 !             ='TABP'; Output to paper (with header information)
 !             ='TABS';
 !             ='TABT';
+!NCF!             ='TABC'; NETCDF output
 !
       CHARACTER RTYPE*4, PSNAME*8
 !
@@ -816,6 +821,7 @@
 !     VOQ
 !
       REAL      VOQ(MIP,*)
+!NCF      REAL      OQR(2)
 !
 !  5. Parameter variables
 !
@@ -830,6 +836,7 @@
 !     NUMDEC
 !
       INTEGER NUMDEC
+!NCF      LOGICAL EXIST
 !
 !  8. Subroutines used
 !
@@ -910,10 +917,18 @@
         IF (NREF.EQ.0) THEN                                               30.82
           FILENM = OUTP_FILES(OQI(2))                                     40.31 40.13
           IOSTAT = -1                                                     20.75
+!NCF          INQUIRE(FILE=FILENM, EXIST=EXIST)
           CALL FOR (NREF, FILENM, 'UF', IOSTAT)
           IF (STPNOW()) RETURN                                            34.01
           OQI(1) = NREF                                                   40.31 30.00
           OUTP_FILES(OQI(2)) = FILENM                                     40.41
+!NCF          IF ( RTYPE .EQ. 'TABC' ) THEN
+!NCF            IF (.NOT.EXIST) CLOSE(NREF, STATUS='DELETE')
+!NCF            CALL swn_outnc_openblockfile(FILENM, 1, MIP,
+!NCF     &                                   OVLNAM, VOQ(:,VOQR(1)),
+!NCF     &                                   VOQ(:,VOQR(2)),
+!NCF     &                                   OQI, OQR, IVTYP, OQI(2))
+!NCF          ENDIF
         END IF                                                            30.82
         IF (RTYPE .NE. 'TABD') THEN
           OUTLIN = '    '
@@ -1049,6 +1064,24 @@
 !
 !     ***** printing of the table *****
 !
+!NCF      IF (RTYPE.EQ.'TABC') THEN
+!NCF        DO JVAR = 1, NVAR
+!NCF          IVTYPE = IVTYP(JVAR)
+!NCF          IF (RTYPE.EQ.'TABC') THEN
+!NCF            CALL swn_outnc_appendblock(1, MIP, IVTYPE, OQI(1),
+!NCF     &                                 OQI(2), VOQ(1,VOQR(IVTYPE)),
+!NCF     &                                 OVEXCV(IVTYPE), 1)
+!NCF            IF ( OVSVTY(IVTYPE).EQ.3 ) THEN
+!NCF              CALL swn_outnc_appendblock(1, MIP, IVTYPE, OQI(1),
+!NCF     &                                   OQI(2), VOQ(1,VOQR(IVTYPE)+1),
+!NCF     &                                   OVEXCV(IVTYPE), 2)
+!NCF            ENDIF
+!NCF          ENDIF
+!NCF        ENDDO
+!NCF        CALL swn_outnc_close_on_end(OQI(1), OQI(2))
+!NCF        RETURN
+!NCF      ENDIF
+!NCF!
       IF (RTYPE.EQ.'TABS') THEN
         IF (NSTATM.EQ.1) WRITE (NREF, 102) CHTIME, 'date and time'
       ENDIF
@@ -1119,7 +1152,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1243,7 +1276,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1608,7 +1641,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1726,6 +1759,7 @@
      &          ACLOC(*)        ,ECOS(MDC)         ,ESIN(MDC)             40.00
       REAL      CG(1), K1(1), K2(1), N(1), ND(1), SIG1(1), SIG2(1)        30.82
       LOGICAL EXCPT                                                       40.80
+      LOGICAL EQREAL                                                      41.54
       REAL, ALLOCATABLE :: ACL(:,:)                                       40.80
 !
       SAVE IENT
@@ -1812,7 +1846,11 @@
 !
 !           EE is energy density in Omega:
 !
-            EE    = ECLL * DSIG / ABS(OMEG2-OMEG1)
+            IF ( .NOT.EQREAL(OMEG1,OMEG2) ) THEN                          41.54
+               EE = ECLL * DSIG / ABS(OMEG2-OMEG1)
+            ELSE                                                          41.54
+               EE = ECLL * DSIG                                           41.54
+            ENDIF                                                         41.54
             IF (ITEST.GE.250 .OR. IOUTES .GE. 40) WRITE (PRTEST, 86)
      &          ID, ISIGM, SIG1(1), K1(1), OMEG1, SIG2(1), K2(1), OMEG2   30.82
   86        FORMAT (' Test SWCMSP/86 ', 2I6, 8(1X,E12.4))
@@ -1843,11 +1881,16 @@
      &                             OMEGA, OMEGB, RUPP, RLOW
   88            FORMAT (' error SWCMSP:', 2I4, 8(1X,E12.4))
               ELSE
+                IF ( .NOT.EQREAL(OMEG1,OMEG2) ) THEN                      41.54
+                   DOMEG = RUPP - RLOW                                    41.54
+                ELSE                                                      41.54
+                   DOMEG = 1.                                             41.54
+                ENDIF                                                     41.54
                 IF (OTYPE.EQ.-2) THEN
                   ACLOC(ID+(IOM-1)*MDC) =
-     &               ACLOC(ID+(IOM-1)*MDC) + EE * (RUPP - RLOW)           40.00
+     &               ACLOC(ID+(IOM-1)*MDC) + EE * DOMEG                   41.54 40.00
                 ELSE
-                  EADD = EE * DDIR * (RUPP - RLOW)                        40.00
+                  EADD = EE * DDIR * DOMEG                                41.54 40.00
                   ACLOC(IOM) = ACLOC(IOM) + EADD
                   ACLOC(IOM+  MSC) = ACLOC(IOM+  MSC) + EADD * ECOS(ID)
                   ACLOC(IOM+2*MSC) = ACLOC(IOM+2*MSC) + EADD * ESIN(ID)
@@ -1932,7 +1975,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2228,7 +2271,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- swanparll.ftn	2014-04-18 10:07:14.000000000 +0200
+++ swanparll.ftn	2015-02-04 11:53:04.000000000 +0100
@@ -50,7 +50,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -228,7 +228,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -349,7 +349,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -476,7 +476,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -611,7 +611,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -752,7 +752,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -886,7 +886,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1077,7 +1077,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1194,7 +1194,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1332,7 +1332,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1468,7 +1468,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1671,7 +1671,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1838,7 +1838,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2180,7 +2180,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2347,7 +2347,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2537,7 +2537,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2703,7 +2703,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2870,7 +2870,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3157,7 +3157,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3496,9 +3496,17 @@
 !                  output locations
 
                IF ( RTYPE(1:3).EQ.'TAB' ) THEN
+!NCF                 IF ( RTYPE.EQ.'TABC') THEN
+!NCF!                 --- use "block" intermediate file facility to pass data between cores
+!NCF                  CALL SWCOLBLK ( RTYPE, CORQ%OQI, CORQ%OQR, CORQ%IVTYP,
+!NCF     &                            CORQ%FAC, SNAMPF, MIP, 1, IRQ,
+!NCF     &                            BLKND, XC, YC )
+!NCF                  IF (STPNOW()) RETURN
+!NCF                 ELSE
                   CALL SWCOLTAB ( RTYPE, CORQ%OQI, CORQ%IVTYP, MIP, IRQ,
      &                            BLKND, XC, YC, XP, YP )                 40.51 40.41
                   IF (STPNOW()) RETURN
+!NCF                 ENDIF
                END IF
 
 !              --- rewrite spectral output by means of collection of
@@ -3582,7 +3590,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3927,7 +3935,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4301,7 +4309,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanPointinMesh.ftn90	2014-04-18 10:07:06.000000000 +0200
+++ SwanPointinMesh.ftn90	2015-02-04 11:53:02.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- swanpre1.ftn	2014-04-18 10:07:14.000000000 +0200
+++ swanpre1.ftn	2015-02-04 11:53:04.000000000 +0100
@@ -38,6 +38,8 @@
       USE M_PARALL                                                        40.31
       USE SwanGriddata                                                    40.80
 !
+      IMPLICIT NONE
+!
 !
 !   --|-----------------------------------------------------------|--
 !     | Delft University of Technology                            |
@@ -50,7 +52,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -282,6 +284,14 @@
 !     POWN      user defined power of redistribution function             40.18
 !     RLAMBDA   Dummy array containing lambda values for quadruplets      40.17
 !
+      INTEGER           :: MPTST,IPP,NLEN,ITRAS,JJ,IGR2,IGRD,MXS,MYS
+      INTEGER           :: IVAL,NUMCOR,MSS,I,J,NVAR,IVTYPE
+      REAL              :: TRCF,HGT,SLP,BK,OGAM,OBET,REF0,XP,YP
+      REAL              :: ALTMP,FRLOW,FRHIG,DIFF,GAMMA,TMPDIR,VALX,VALY
+      REAL              :: DEGCNV
+      REAL              :: HH, CC, DD
+      INTEGER           :: NN
+!
       INTEGER, SAVE     :: INCNUM(1:MXINCL) = 0                           40.03
       INTEGER, SAVE     :: INCLEV = 1                                     40.03
 !
@@ -1322,7 +1332,7 @@
 ! ===========================================================================
 !
 !          / REGular [xpc] [ypc] [alpc] [xlenc] [ylenc] [mxc] [myc] \
-!   CGRID <  CURVilinear [mxc] [myc]  [excval]                       >   &
+!   CGRID <  CURVilinear [mxc] [myc]  [excval] [alpc]                >   &
 !          \ UNSTRUCtured                                           /
 !
 !          / CIRcle               \
@@ -1350,9 +1360,9 @@
           XCLEN = 0.
           YCLEN = 0.
           IF (ITEST.GE.30) THEN                                           40.41
-          CALL MSGERR(1,'there is an unresolved problem with the')        40.08
+          CALL MSGERR(1,'there is an unusual issue with the')             41.53 40.08
           CALL MSGERR(1,'curvilinear mode, so use with caution.')         40.08
-          CALL MSGERR(1,'This problem occurs when the upwind point')      40.08
+          CALL MSGERR(1,'This issue occurs when the upwind point')        40.08
           CALL MSGERR(1,'has not been solved for yet, because it')        40.08
           CALL MSGERR(1,'falls into a different sweep. Normally,')        40.08
           CALL MSGERR(1,'an upwind point will always fall within')        40.08
@@ -1362,6 +1372,8 @@
           CALL MSGERR(1,'the axis of the grid bends about the')           40.08
           CALL MSGERR(1,'direction associated with a particular')         40.08
           CALL MSGERR(1,'directional bin.')                               40.08
+          CALL MSGERR(1,'You may use command SET CURV or enlarge')        41.53
+          CALL MSGERR(1,'parameter [mxitst].')                            41.53
           END IF                                                          40.41
         ELSEIF (KEYWIS('UNSTRUC')) THEN                                   40.80
           OPTG  = 5                                                       40.80
@@ -1446,6 +1458,9 @@
             CALL INREAL ('EXCVAL', EXCFLD(8), 'REQ', 0.)                  30.60
             CALL INREAL ('EXCVAL', EXCFLD(9), 'STA', EXCFLD(8))           30.60
           ENDIF                                                           30.60
+          CALL INREAL ('ALPC',ALPC,'STA',0.)                              41.53
+          ALTMP = ALPC / 360.                                             41.53
+          ALPC = PI2 * (ALTMP - NINT(ALTMP))                              41.53
         ENDIF                                                             30.60
 !
         CALL INKEYW ('STA', 'CIR')                                        20.67
@@ -1766,14 +1781,6 @@
 !
         END IF
 !
-!       limit Csigma if user want so                                      41.35
-!
-        CALL INKEYW ('STA','  ')
-        IF (KEYWIS ('CS')) THEN
-           PNUMS(33) = 1.
-           CALL INREAL ('CFL', PNUMS(34) ,'STA', 0.5)
-        ENDIF
-!
 !       limit Ctheta if user want so                                      41.35
 !
         CALL INKEYW ('STA','  ')
@@ -1782,6 +1789,14 @@
            CALL INREAL ('CFL', PNUMS(36) ,'STA', 0.5)
         ENDIF
 !
+!       limit Csigma if user want so                                      41.35
+!
+        CALL INKEYW ('STA','  ')
+        IF (KEYWIS ('CS')) THEN
+           PNUMS(33) = 1.
+           CALL INREAL ('CFL', PNUMS(34) ,'STA', 0.5)
+        ENDIF
+!
         CALL INKEYW ('STA','  ')                                          30.82
         IF (KEYWIS('SETUP')) THEN                                         30.82
 !         *** iterative solver        ***                                 30.82
@@ -1848,10 +1863,10 @@
 !
 ! =============================================================
 !
-!   SET  [level]  [nor]  [depmin]  [maxmes]        &
-!        [maxerr]  [grav]  [rho] [cdcap] [inrhog]  &
-!        [hsrerr]  CARTesian/NAUTical  [pwtail]    &
-!        [froudmax]  [sort]  [printf]  [prtest]
+!   SET  [level]  [nor]  [depmin]  [maxmes]           &
+!        [maxerr]  [grav]  [rho] [cdcap] [inrhog]     &
+!        [hsrerr]  CARTesian/NAUTical  [pwtail]       &
+!        [froudmax]  [sort]  CURV  [printf]  [prtest]
 !
 ! =============================================================
 !
@@ -1900,6 +1915,7 @@
          ENDIF
          CALL INREAL ('FROUDMAX', PNUMS(18), 'UNC', 0.)                   30.50
          CALL INREAL ('SORT'    , asort    , 'UNC', 0.)                   41.48
+         IF (KEYWIS ('CURV')) CCURV = .TRUE.                              41.53
          CALL ININTG ('PRINTF'  , PRINTF   , 'UNC', 0 )
          CALL ININTG ('PRTEST'  , PRTEST   , 'UNC', 0 )
          if ( asort.ne.-999. ) then                                       41.48
@@ -2721,12 +2737,15 @@
            CALL INREAL ('TRFAC', PTRIAD(1), 'STA', 0.65)                  41.44
            CALL INREAL ('CUTFR', PTRIAD(2), 'STA', 2.5)                   40.61 40.56 30.82
         ELSEIF (ITRIAD.EQ.2) THEN
-           CALL INREAL ('TRFAC', PTRIAD(1), 'STA', 1.0)                   41.46
+           CALL INREAL ('TRFAC', PTRIAD(1), 'STA', 0.05)                  41.46
            CALL INREAL ('A'    , PTRIAD(6), 'STA', 0.95)                  41.46
            CALL INREAL ('B'    , PTRIAD(7), 'STA',-0.75)                  41.46
         ELSEIF (ITRIAD.EQ.5) THEN
            CALL INREAL ('TRFAC', PTRIAD(1), 'STA', 0.35)                  41.45
            CALL INREAL ('CUTFR', PTRIAD(2), 'STA', 1.33333333)
+        ELSEIF (ITRIAD.EQ.11) THEN
+           CALL INREAL ('TRFAC', PTRIAD(1), 'STA', 0.05)
+           CALL INREAL ('CUTFR', PTRIAD(2), 'STA', 2.5)
         ENDIF
         CALL INREAL ('URCRIT', PTRIAD(4), 'UNC', 0.0)                     40.13
         CALL INREAL ('URSLIM', PTRIAD(5), 'STA', 0.01)                    40.41 40.23 40.13
@@ -2840,7 +2859,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3275,7 +3294,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3788,7 +3807,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3955,7 +3974,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4218,7 +4237,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4433,7 +4452,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4798,7 +4817,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4908,7 +4927,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5080,7 +5099,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5251,7 +5270,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5850,7 +5869,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- swanpre2.ftn	2014-04-18 10:07:14.000000000 +0200
+++ swanpre2.ftn	2015-02-04 11:53:04.000000000 +0100
@@ -36,7 +36,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -202,7 +202,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1028,6 +1028,7 @@
       USE SWCOMM4                                                         40.41
       USE OUTP_DATA                                                       40.13
       USE M_PARALL                                                        40.31
+!NCF      USE swn_outnc                                                       41.52
 !PUN      USE SIZES                                                           40.95
 !
 !
@@ -1042,7 +1043,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1246,6 +1247,14 @@
   70      CALL SVARTP (IVTYPE)
           IF (IVTYPE .EQ. 98) GOTO 91                                     30.00
           IF (IVTYPE .NE. 99) THEN
+!NCF             IF ( INDEX(FILENM,'.NC').NE.0  .OR.                          41.52
+!NCF     &            INDEX(FILENM,'.nc').NE.0 ) THEN                         41.52
+!NCF                IF ( IVTYPE.GT.2 ) THEN                                   41.52
+!NCF                   call stnames_init()                                    41.52
+!NCF                   IF ( STNAMES(IVTYPE,1).EQ. ' ' ) CALL MSGERR (2,       41.52
+!NCF     &                   'netCDF output not allowed for '//TRIM(FILENM))  41.52
+!NCF                ENDIF                                                     41.52
+!NCF             ENDIF                                                        41.52
              CALL INREAL ('UNIT', DFAC, 'STA', -1.)
              IF (OVSVTY(IVTYPE).EQ.5) THEN
                CALL MSGERR (2,
@@ -1428,6 +1437,11 @@
 !       unit reference number NREF is 0, will be determined in output module
         CALL INCSTR ('FNAME', FILENM, 'STA', ' ')
         IF (FILENM .NE. '    ') THEN
+!NCF          IF ( INDEX( FILENM, '.NC' ).NE.0 .OR.
+!NCF     &         INDEX (FILENM, '.nc' ).NE.0 ) THEN
+!NCF            RTYPE = 'TABC'
+!NCF            ORQTMP%RQTYPE = RTYPE
+!NCF          ENDIF
           NREF = 0
 !         --- append node number to FILENM in case of                     40.30
 !             parallel computing                                          40.30
@@ -1453,6 +1467,14 @@
    80   CALL SVARTP (IVTYPE)
         IF (IVTYPE .EQ. 98) GOTO 90                                       30.00
         IF (IVTYPE .NE. 99) THEN
+!NCF           IF ( INDEX(FILENM,'.NC').NE.0  .OR.                            41.52
+!NCF     &          INDEX(FILENM,'.nc').NE.0 ) THEN                           41.52
+!NCF              IF ( IVTYPE.GT.2 ) THEN                                     41.52
+!NCF                 call stnames_init()                                      41.52
+!NCF                 IF ( STNAMES(IVTYPE,1).EQ. ' ' ) CALL MSGERR (2,         41.52
+!NCF     &                   'netCDF output not allowed for '//TRIM(FILENM))  41.52
+!NCF              ENDIF                                                       41.52
+!NCF           ENDIF                                                          41.52
           IF (OVSVTY(IVTYPE).EQ.5) THEN
             CALL MSGERR (2,
      &      'Type of output not allowed for this quantity')
@@ -1570,7 +1592,12 @@
            END DO                                                         40.31
            DEALLOCATE(TMP)                                                40.31
         END IF                                                            40.31
+!NCF        IF ( RTYPE.EQ.'TABC') THEN
+!NCF          ALLOCATE(ORQTMP%FAC(NVAR))
+!NCF          ORQTMP%FAC=1.
+!NCF        ELSE
         ALLOCATE(ORQTMP%FAC(0))                                           40.31
+!NCF        ENDIF
 
         IF (IVTYPE .EQ. 98) THEN                                          30.00
           IF (NSTATM.EQ.0) CALL MSGERR (3,
@@ -1602,8 +1629,8 @@
       ENDIF
 !
 !   --------------------------------------------------------------------------
-!   SPECout 'sname'  SPEC1D/SPEC2D  ABS/REL   'fname'                       &
-!NCF!                    (MONth  ESCAle MDGRID COMPress) (NOT documented)       &
+!   SPECout 'sname'  SPEC1D/SPEC2D  ABS/REL   'fname'                        &
+!NCF!                    (MONth  ESCAle MDGRID COMPress NOAUX) (NOT documented)  &
 !                    (OUTPUT [tbegspc] [deltspc] SEC/MIN/HR/DAY)
 !   --------------------------------------------------------------------------
 !   SPEC   output of spectra
@@ -1670,6 +1697,10 @@
 !NCF           ORQTMP%OQI(4) = ORQTMP%OQI(4) + 8
 !NCF        ENDIF
 !NCF        CALL INKEYW ('STA', ' ')
+!NCF        IF (KEYWIS('NOAUX')) THEN
+!NCF           ORQTMP%OQI(4) = ORQTMP%OQI(4) + 16
+!NCF        ENDIF
+!NCF        CALL INKEYW ('STA', ' ')
 !
         NVAR = 0                                                          40.31
         ORQTMP%OQI(3) = NVAR                                              40.31
@@ -1752,6 +1783,10 @@
           OUTP_FILES(NREOQ) = FILENM                                      40.31 40.13
           NVAR = 0                                                        40.31
           ORQTMP%OQI(3) = NVAR                                            40.31
+!NCF!         scale spectra and do not store auxillary variables
+!NCF          IF ( INDEX( FILENM, '.NC'  ).NE.0 .OR.
+!NCF     &         INDEX (FILENM, '.nc'  ).NE.0 )
+!NCF     &       ORQTMP%OQI(4) = 18
           ALLOCATE(ORQTMP%IVTYP(0))                                       40.31
           ALLOCATE(ORQTMP%FAC(0))                                         40.31
 !
@@ -1808,7 +1843,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1978,7 +2013,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2096,7 +2131,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2228,7 +2263,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3474,7 +3509,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3965,7 +4000,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4555,7 +4590,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5016,7 +5051,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5336,7 +5371,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5500,7 +5535,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanPrepComp.ftn90	2014-04-18 10:07:08.000000000 +0200
+++ SwanPrepComp.ftn90	2015-02-04 11:53:02.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanPrintGridInfo.ftn90	2014-04-18 10:07:08.000000000 +0200
+++ SwanPrintGridInfo.ftn90	2015-02-04 11:53:02.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanPropvelS.ftn90	2014-04-18 10:07:08.000000000 +0200
+++ SwanPropvelS.ftn90	2015-02-04 11:53:02.000000000 +0100
@@ -16,7 +16,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanPropvelX.ftn90	2014-04-18 10:07:08.000000000 +0200
+++ SwanPropvelX.ftn90	2015-02-04 11:53:02.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanPunCollect.ftn90	2014-04-18 10:07:08.000000000 +0200
+++ SwanPunCollect.ftn90	2015-02-04 11:53:02.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanReadADCGrid.ftn90	2014-04-18 10:07:09.000000000 +0200
+++ SwanReadADCGrid.ftn90	2015-02-04 11:53:03.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanReadEasymeshGrid.ftn90	2014-04-18 10:07:09.000000000 +0200
+++ SwanReadEasymeshGrid.ftn90	2015-02-04 11:53:03.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanReadfort18.ftn90	2014-04-18 10:07:09.000000000 +0200
+++ SwanReadfort18.ftn90	2015-02-04 11:53:03.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanReadGrid.ftn90	2014-04-18 10:07:09.000000000 +0200
+++ SwanReadGrid.ftn90	2015-02-04 11:53:03.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanReadTriangleGrid.ftn90	2014-04-18 10:07:09.000000000 +0200
+++ SwanReadTriangleGrid.ftn90	2015-02-04 11:53:03.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- swanser.ftn	2014-04-18 10:07:14.000000000 +0200
+++ swanser.ftn	2015-02-04 11:53:04.000000000 +0100
@@ -23,7 +23,7 @@
 !     SINTRP                                                              40.00
 !     HSOBND                                                              32.01
 !     CHGBAS                                                              40.00
-!     GAMMA                                                               40.00
+!     GAMMAF                                                              40.00
 !     WRSPEC                                                              40.00
 !TIMG!     SWTSTA                                                              40.23
 !TIMG!     SWTSTO                                                              40.23
@@ -70,7 +70,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -204,7 +204,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -331,7 +331,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -430,7 +430,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -584,7 +584,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -759,7 +759,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -927,7 +927,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1064,7 +1064,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1135,7 +1135,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1365,7 +1365,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1706,7 +1706,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1894,7 +1894,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2109,7 +2109,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2261,7 +2261,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2383,7 +2383,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2599,7 +2599,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2798,7 +2798,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3015,7 +3015,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3301,7 +3301,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3417,7 +3417,7 @@
       REAL     :: AC2(MDC,MSC,MCGRD)                                      40.09 40.22
 !     Changed ICMAX to MICMAX, since MICMAX doesn't vary over gridpoint   40.22
       REAL     :: CAX(MDC,MSC,MICMAX), CAY(MDC,MSC,MICMAX)                40.09 40.22
-      REAL     :: REFLSO(MDC,MSC), RDX(10), RDY(10)                       40.41 40.09 40.22 40.08
+      REAL     :: REFLSO(MDC,MSC), RDX(MICMAX), RDY(MICMAX)               40.41 40.09 40.22 40.08
       REAL     :: SPCSIG(MSC), SPCDIR(MDC,6)                              40.13 40.28
       LOGICAL  :: ANYBIN(MDC,MSC)                                         40.09
 !
@@ -3793,7 +3793,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -3889,7 +3889,7 @@
 !     Changed ICMAX to MICMAX, since MICMAX doesn't vary over gridpoint   40.22
       REAL       :: CAX(MDC,MSC,MICMAX), CAY(MDC,MSC,MICMAX)              40.18 40.22
       REAL       :: REFLSO(MDC,MSC), OBREDF(MDC,MSC,2)                    40.41 40.18
-      REAL       :: RDX(10), RDY(10)                                      40.18 40.08
+      REAL       :: RDX(MICMAX), RDY(MICMAX)                              40.18 40.08
       REAL       :: FD1, FD2, FD3, FD4, SPCSIG(MSC), SPCDIR(MDC,6)        40.41 40.28
       REAL       :: REF0                                                  40.18
       REAL       :: X1, X2, X3, X4, Y1, Y2, Y3, Y4                        40.18
@@ -4141,7 +4141,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4509,7 +4509,7 @@
         MS = SPPARM(4)
       ENDIF
       IF (MS.LT.12.) THEN
-        CTOT = (2.**MS) * (GAMMA(0.5*MS+1.))**2 / (PI * GAMMA(MS+1.))
+        CTOT = (2.**MS) * (GAMMAF(0.5*MS+1.))**2 / (PI * GAMMAF(MS+1.))
       ELSE
         CTOT =  SQRT (0.5*MS/PI) / (1. - 0.25/MS)
       ENDIF
@@ -4518,8 +4518,8 @@
         DO IS = 1, MSC
           ESOM = ESOM + FRINTF * SPCSIG(IS)**2 * ACLOC(MDC,IS)
         ENDDO
-        GAM1 = GAMMA(0.5*MS+1.)                                                40.84
-        GAM2 = GAMMA(MS+1.)                                                    40.84
+        GAM1 = GAMMAF(0.5*MS+1.)                                               40.84
+        GAM2 = GAMMAF(MS+1.)                                                   40.84
         WRITE (PRTEST, *) ' SSHAPE dir ', 4.*SQRT(ABS(ESOM)),
      &        SPPARM(1), CTOT, MS, GAM1, GAM2, CTOT                            40.84 40.02
       ENDIF
@@ -4573,7 +4573,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -4975,7 +4975,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5100,7 +5100,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5198,7 +5198,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5298,7 +5298,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5486,7 +5486,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5721,7 +5721,7 @@
 !
 !********************************************************************
 !                                                                   *
-      REAL FUNCTION GAMMA(XX)
+      REAL FUNCTION GAMMAF(XX)
 !                                                                   *
 !********************************************************************
 !
@@ -5737,11 +5737,11 @@
       REAL XX, YY, ABIG                                                   40.00
       SAVE IENT, ABIG
       DATA IENT /0/, ABIG /30./
-      CALL STRACE (IENT, 'GAMMA')
+      CALL STRACE (IENT, 'GAMMAF')
       YY = GAMMLN(XX)
       IF (YY.GT.ABIG) YY = ABIG
       IF (YY.LT.-ABIG) YY = -ABIG
-      GAMMA = EXP(YY)
+      GAMMAF = EXP(YY)
       RETURN
       END
 !********************************************************************
@@ -5792,7 +5792,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -5928,7 +5928,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -6044,7 +6044,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -6213,7 +6213,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -6376,7 +6376,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -6740,7 +6740,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -6842,7 +6842,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -6934,7 +6934,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -7016,7 +7016,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -7131,7 +7131,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -7246,7 +7246,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -7387,7 +7387,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -7502,9 +7502,9 @@
 !MatL4!           :     (for 32-bit machine, lfrac=23)
 !MatL4!     RFRAC :     auxiliary real with fraction
 !MatL4!
-!MatL4      INTEGER ACTEXP, EXPO, I, IENT, IPART, LFRAC, BIAS, BEXPO,
-!MatL4     &        LEADNR, IQUOT
-!MatL4      REAL FRAC, RFRAC
+!MatL4      INTEGER ACTEXP, EXPO, I, IENT, IPART, LFRAC, BIAS, BEXPO
+!MatL4      INTEGER*8 LEADNR, IQUOT
+!MatL4      REAL FRAC, RFRAC, MAXREAL
 !MatL4!
 !MatL4! 12. Structure
 !MatL4!
@@ -7530,13 +7530,22 @@
 !MatL4 10   CONTINUE
 !MatL4      BEXPO  = -1
 !MatL4
+!MatL4!     --- clamp reals to the max integer*8, to prevent overflow
+!MatL4
+!MatL4      MAXREAL=9.0E+18
+!MatL4      IF ( RVAL .GT. MAXREAL ) THEN
+!MatL4         RVAL=MAXREAL
+!MatL4      ELSEIF ( RVAL .LT. -MAXREAL ) THEN
+!MatL4         RVAL=-MAXREAL
+!MatL4      END IF
+!MatL4
 !MatL4!     --- determine leading number and fraction
 !MatL4
 !MatL4      IF ( ABS(RVAL).LT.1.E-7 ) THEN
 !MatL4         LEADNR = 0
 !MatL4         FRAC   = 0.
 !MatL4      ELSE
-!MatL4         LEADNR = INT(ABS(RVAL))
+!MatL4         LEADNR = INT(ABS(RVAL),KIND=8)
 !MatL4         FRAC   = ABS(RVAL) - REAL(LEADNR)
 !MatL4      END IF
 !MatL4
@@ -7548,7 +7557,7 @@
 !MatL4         IQUOT = LEADNR
 !MatL4 30      IF ( IQUOT.GE.2 ) THEN
 !MatL4
-!MatL4              IQUOT = INT(IQUOT/2)
+!MatL4              IQUOT = INT(IQUOT/2,KIND=8)
 !MatL4              EXPO  = EXPO + 1
 !MatL4
 !MatL4         GOTO 30
--- SwanSumOverNodes.ftn90	2014-04-18 10:07:10.000000000 +0200
+++ SwanSumOverNodes.ftn90	2015-02-04 11:53:03.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanSweepSel.ftn90	2014-04-18 10:07:10.000000000 +0200
+++ SwanSweepSel.ftn90	2015-02-04 11:53:03.000000000 +0100
@@ -14,7 +14,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanThreadBounds.ftn90	2014-04-18 10:07:10.000000000 +0200
+++ SwanThreadBounds.ftn90	2015-02-04 11:53:03.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanTranspAc.ftn90	2014-04-18 10:07:11.000000000 +0200
+++ SwanTranspAc.ftn90	2015-02-04 11:53:03.000000000 +0100
@@ -16,7 +16,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanTranspX.ftn90	2014-04-18 10:07:11.000000000 +0200
+++ SwanTranspX.ftn90	2015-02-04 11:53:03.000000000 +0100
@@ -13,7 +13,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- SwanVertlist.ftn90	2014-04-18 10:07:11.000000000 +0200
+++ SwanVertlist.ftn90	2015-02-04 11:53:03.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- swmod1.ftn	2014-04-18 10:07:14.000000000 +0200
+++ swmod1.ftn	2015-02-04 11:53:04.000000000 +0100
@@ -26,7 +26,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -184,7 +184,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -306,7 +306,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -409,7 +409,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -552,7 +552,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1426,7 +1426,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1499,6 +1499,7 @@
 ! grid(13): fluid mud layer
 !
 ! ALPG(NUMGRD)  [    0.] direction of the x-axis w.r.t. user coordinates
+! CCURV         [ FALSE] correction curvilinear grid
 ! COSPG(NUMGRD) [    1.] cos of ALPG
 ! COSVC         [CALCUL] =COS(-ALPG(2)),
 !                        cos of angle of current input grid w.r.t. user coordinates
@@ -1570,6 +1571,7 @@
       LOGICAL VARWI,       VARWLV,      DYNDEP
       LOGICAL VARAST
       LOGICAL VARNPL,      VARTUR,      VARMUD
+      LOGICAL CCURV                                                       41.53
 !
 !     *** variables for input files ***
 !
@@ -1633,7 +1635,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -1914,6 +1916,7 @@
 !                  direction of user coordinates w.r.t. computational coordinates
 ! ALOCMP [ FALSE]  if True, array COMPDA must be re-allocated
 ! ALPC   [    0.]  direction of x-axis of computational grid w.r.t. user coordinates
+! COSLAT [    10]  cos of latitude; =1 for Cartesian coordinates
 ! COSPC  [CALCUL] =COS(ALPC)
 ! DX     [CALCUL] =XCLEN/MXS; mesh size in x-direction of computational grid
 ! DY     [CALCUL] =YCLEN/MYS; mesh size in y-direction of computational grid
@@ -1970,6 +1973,7 @@
       INTEGER             MXC,         MYC,         NX,          NY
       INTEGER             NGRBND
       INTEGER             ILMAX
+      REAL                COSLAT(MICMAX)
       REAL                ALCP,        ALPC,        COSPC,       DDIR
       REAL                DX,          DXRP,        DY,          DYRP
       REAL                FRINTF,      FRINTH,      SHIG,        SINPC
@@ -1979,7 +1983,7 @@
       REAL                XCGMIN,      XCGMAX,      YCGMIN,      YCGMAX
       LOGICAL             FULCIR
       LOGICAL ::          ALOCMP = .FALSE.                                40.97
-!$OMP THREADPRIVATE(IXCGRD,IYCGRD,KCGRD)
+!$OMP THREADPRIVATE(IXCGRD,IYCGRD,KCGRD,COSLAT)
 !
 !     *** physical parameters ***
 !
@@ -2540,7 +2544,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -2630,7 +2634,6 @@
 !
 !     *** higher order propagation and spherical coordinates ***
 !
-! COSLAT [    10] cos of latitude; =1 for Cartesian coordinates
 ! KREPTX [     0] if >0, the domain repeats itself in x-direction (primarily intended for
 !                 propagation around the globe)
 ! KSPHER [     0] indicates whether spherical coordinates are used, and which projection method
@@ -2655,8 +2658,7 @@
       INTEGER PROPSS,    PROPSN,    PROJ_METHOD
       INTEGER PROPFL
       REAL    WAVAGE,    REARTH,    LENDEG
-      REAL    COSLAT(10)
-!$OMP THREADPRIVATE(COSLAT,PROPSL)
+!$OMP THREADPRIVATE(PROPSL)
 !
 !  8. Subroutines and functions used
 !
@@ -2696,7 +2698,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- swmod2.ftn	2014-04-18 10:07:14.000000000 +0200
+++ swmod2.ftn	2015-02-04 11:53:04.000000000 +0100
@@ -25,7 +25,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -148,7 +148,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -291,7 +291,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -393,7 +393,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -538,7 +538,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -650,7 +650,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -794,7 +794,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -974,7 +974,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
--- swn_outnc.ftn90	2014-04-18 10:07:12.000000000 +0200
+++ swn_outnc.ftn90	2015-02-04 11:53:04.000000000 +0100
@@ -11,7 +11,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -113,7 +113,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -262,7 +262,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -357,6 +357,7 @@
         spcaux%wndx    = OVEXCV(26)
         spcaux%wndy    = OVEXCV(26)
 
+        if (RTYPE(3:3) .eq. 'R') spcaux%relative = .true.
         if (RTYPE(4:4) .eq. 'C') then
             allocate(spcaux%E(MSC * MDC, MIP))
             spcaux%is2d = .true.
@@ -506,7 +507,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -898,7 +899,7 @@
 !
 !
 !     SWAN (Simulating WAves Nearshore); a third generation wave model
-!     Copyright (C) 1993-2014  Delft University of Technology
+!     Copyright (C) 1993-2015  Delft University of Technology
 !
 !     This program is free software; you can redistribute it and/or
 !     modify it under the terms of the GNU General Public License as
@@ -944,7 +945,7 @@
                                              ncid
       character*256                       :: errmsg
       integer, save                       :: IENT=0
-      logical                             :: spc_as_map, wetnode_list
+      logical                             :: spc_as_map, wetnode_list, noaux
       type(spcaux_type), target           :: lspcaux
       type(spcaux_type), pointer          :: pspcaux
 
@@ -977,7 +978,7 @@
       irq  = oqi(2)
       ncid = oqi(1) + ncoffset(irq)
 
-      call swn_outnc_spcflags(oqi(4), spc_as_map, wetnode_list, spcaux)
+      call swn_outnc_spcflags(oqi(4), spc_as_map, wetnode_list, spcaux, noaux=noaux)
 
 !
 ! Determine the index in the record axe
@@ -1044,21 +1045,23 @@
 !
 !     hs is provided so that user can check his integration routines. His / hers
 !     hs should match the one computed by SWAN.
-      if ( spc_as_map ) then
-          call agnc_add_mapdata(ncid, 'depth', ri, pspcaux%depth, OVEXCV( 4), skip_range_error)
-          call agnc_add_mapdata(ncid, 'xcur',  ri, pspcaux%ux,    OVEXCV( 5), skip_range_error)
-          call agnc_add_mapdata(ncid, 'ycur',  ri, pspcaux%uy,    OVEXCV( 5), skip_range_error)
-          call agnc_add_mapdata(ncid, 'hs',    ri, pspcaux%hs,    OVEXCV(10), skip_range_error)
-          call agnc_add_mapdata(ncid, 'xwnd',  ri, pspcaux%wndx,  OVEXCV(26), skip_range_error)
-          call agnc_add_mapdata(ncid, 'ywnd',  ri, pspcaux%wndy,  OVEXCV(26), skip_range_error)
-      else
-          call agnc_add_pntdata(ncid, 'depth', ri, pspcaux%depth, OVEXCV( 4), skip_range_error)
-          call agnc_add_pntdata(ncid, 'xcur',  ri, pspcaux%ux,    OVEXCV( 5), skip_range_error)
-          call agnc_add_pntdata(ncid, 'ycur',  ri, pspcaux%uy,    OVEXCV( 5), skip_range_error)
-          call agnc_add_pntdata(ncid, 'hs',    ri, pspcaux%hs,    OVEXCV(10), skip_range_error)
-          call agnc_add_pntdata(ncid, 'xwnd',  ri, pspcaux%wndx,  OVEXCV(26), skip_range_error)
-          call agnc_add_pntdata(ncid, 'ywnd',  ri, pspcaux%wndy,  OVEXCV(26), skip_range_error)
-      end if
+      if ( .not.noaux ) then
+        if ( spc_as_map ) then
+            call agnc_add_mapdata(ncid, 'depth', ri, pspcaux%depth, OVEXCV( 4), skip_range_error)
+            call agnc_add_mapdata(ncid, 'xcur',  ri, pspcaux%ux,    OVEXCV( 5), skip_range_error)
+            call agnc_add_mapdata(ncid, 'ycur',  ri, pspcaux%uy,    OVEXCV( 5), skip_range_error)
+            call agnc_add_mapdata(ncid, 'hs',    ri, pspcaux%hs,    OVEXCV(10), skip_range_error)
+            call agnc_add_mapdata(ncid, 'xwnd',  ri, pspcaux%wndx,  OVEXCV(26), skip_range_error)
+            call agnc_add_mapdata(ncid, 'ywnd',  ri, pspcaux%wndy,  OVEXCV(26), skip_range_error)
+        else
+            call agnc_add_pntdata(ncid, 'depth', ri, pspcaux%depth, OVEXCV( 4), skip_range_error)
+            call agnc_add_pntdata(ncid, 'xcur',  ri, pspcaux%ux,    OVEXCV( 5), skip_range_error)
+            call agnc_add_pntdata(ncid, 'ycur',  ri, pspcaux%uy,    OVEXCV( 5), skip_range_error)
+            call agnc_add_pntdata(ncid, 'hs',    ri, pspcaux%hs,    OVEXCV(10), skip_range_error)
+            call agnc_add_pntdata(ncid, 'xwnd',  ri, pspcaux%wndx,  OVEXCV(26), skip_range_error)
+            call agnc_add_pntdata(ncid, 'ywnd',  ri, pspcaux%wndy,  OVEXCV(26), skip_range_error)
+        end if
+    end if
 
       ! garbage collect
       nullify(pspcaux)
@@ -1110,7 +1113,7 @@
 !
         logical                               :: file_exists, nc_debug, &
                                                  Escale, monthly, spc_as_map, &
-                                                 wetnode_list, STPNOW
+                                                 wetnode_list, STPNOW, noaux
         integer                               :: ncid, xpctmp(2), i, irq
         type(spcgrid_type)                    :: spcgrid
         type(mapgrid_type)                    :: mapgrid
@@ -1124,7 +1127,7 @@
 
         if (LTRACE) call STRACE (IENT,'swn_outnc_openspecfile')
 
-        call swn_outnc_spcflags(oqi(4), spc_as_map, wetnode_list, spcaux, Escale, monthly)
+        call swn_outnc_spcflags(oqi(4), spc_as_map, wetnode_list, spcaux, Escale, noaux, monthly)
         irq = OQI(2)
 
         if ( .not. stnames_initialized ) call stnames_init()
@@ -1279,7 +1282,7 @@
 !
 ! 6.b) create variables
 !
-            call create_auxvariables(ncid, spc_as_map)
+            if ( .not.noaux ) call create_auxvariables(ncid, spc_as_map)
 
 
 ! 6.c) close define mode and reopen write
@@ -1318,40 +1321,53 @@
 
     end subroutine swn_outnc_openspecfile
 
-    subroutine swn_outnc_spcflags(oqi, spc_as_map, wetnode_list, spcaux, Escale, monthly)
+    subroutine swn_outnc_spcflags(oqi, spc_as_map, wetnode_list, spcaux, Escale, noaux, monthly)
         integer,                intent(   in) :: oqi
         type(spcaux_type),      intent(   in) :: spcaux
         logical,                intent(  out) :: spc_as_map, wetnode_list
-        logical, optional,      intent(  out) :: Escale, monthly
+        logical, optional,      intent(  out) :: Escale, monthly, noaux
 
+        integer                               :: iocode
+
+        iocode       = oqi
         wetnode_list = .false.
         spc_as_map   = .false.
+        noaux        = .false.
+
+        if ( iocode >= 16 ) then
+            noaux  = .true.
+            iocode = iocode - 16
+        end if
 
         ! MDGRID is the special keyword to store spectra (including dry points) on the
         ! full geographic grid instead of along a pointlist
         ! On the other hand, when COMPGRID is requested on any grid but unstructured,
         ! store the point indices in the computational grid in the netcdf file
         if ( spcaux%mip == MCGRDGL-1 .or. spcaux%mip == (MXCGL * MYCGL) ) then
-            if (oqi >= 8 ) then
+            if (iocode >= 8 ) then
                 spc_as_map = .true.
-            elseif ( oqi >= 4 .and. OPTG /= 5  ) then
+                iocode     = iocode - 8
+            elseif ( iocode >= 4 .and. OPTG /= 5  ) then
                 ! request to remove dry points from COMPGRID pointlist, e.g., compress
                 wetnode_list = .true.
             end if
         end if
 
+        ! catch conflicting MDGRID + COMPRESS
+        iocode       = mod(iocode, 4)
+
         ! Enery scaling is of creating a new variable that stores a scale per timestep and point
         ! the energy itself is then stored as int16 instead of float
         if ( present( EScale) ) then
             Escale = .false.
-            if ( mod(oqi, 4) > 1) Escale = .true.
+            if ( iocode > 1) Escale = .true.
         end if
 
          ! By setting the keyword MONTH a netcdf file is created that has a time axis
         ! starting at the first of the month.
         if ( present( monthly ) ) then
             monthly = .false.
-            if ( mod(oqi,2) == 1 .and. NSTATM == 1) monthly = .true.
+            if ( mod(iocode,2) == 1 .and. NSTATM == 1) monthly = .true.
         end if
 
     end subroutine swn_outnc_spcflags
@@ -1504,8 +1520,8 @@
                 recordaxe(irq)%nstatm     = .false.
             end if
 
-            if (OPTG == 5) then
-                ! unstructured mesh is a pointlist
+            if (myk == 1) then
+                ! unstructured mesh is a pointlist. TABLE output also uses this section
                 pntgrid%npoints = mxk
                 allocate (pntgrid%longitude(mxk))
                 allocate (pntgrid%latitude(mxk))
